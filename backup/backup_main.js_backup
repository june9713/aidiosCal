function getCurrentTime() {
    const KR_TIME_DIFF=9*60*60*1000;
    return new Date(Date.now() + KR_TIME_DIFF);
}
// ë¡œê¹… ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ìˆ˜ì •
async function log(type, message, data = null) {
    const now = getCurrentTime();
    const timestamp = now.toISOString();
    const logMessage = `[${timestamp}] [${type}] ${message}`;
    
    switch(type) {
        case 'ERROR':
            console.error(logMessage, data || '');
            break;
        case 'WARN':
            console.warn(logMessage, data || '');
            break;
        case 'INFO':
            console.info(logMessage, data || '');
            break;
        case 'DEBUG':
            console.debug(logMessage, data || '');
            break;
        default:
            console.log(logMessage, data || '');
    }
}

// Global variables
let currentUser = null;
let schedules = [];
let showCompleted = true;
let completedOnly = false; // ì™„ë£Œëœ ì¼ì •ë§Œ ë³´ê¸° ìƒíƒœ
let selectedUsers = new Set();
let tokenRefreshInterval = null;
let currentPage = 1;
let isLoading = false;
let hasMoreSchedules = true;
const SCHEDULES_PER_PAGE = 50;

// DOM Elements
const authContainer = document.getElementById('auth-container');
const loginForm = document.getElementById('login-form');
const registerForm = document.getElementById('register-form');
const showRegisterLink = document.getElementById('show-register');
const showLoginLink = document.getElementById('show-login');

// Event Listeners
document.addEventListener('DOMContentLoaded', () => {
    log('INFO', 'DOMContentLoaded ì´ë²¤íŠ¸ ë°œìƒ');
    log('INFO', 'Application initialized');
    
    const token = localStorage.getItem('token');
    const userData = localStorage.getItem('userData');
    
    log('DEBUG', 'ì €ì¥ëœ ë°ì´í„° í™•ì¸', { 
        hasToken: !!token, 
        hasUserData: !!userData,
        tokenLength: token ? token.length : 0
    });
    
    if (token && userData) {
        log('DEBUG', 'Found stored token and user data');
        try {
            currentUser = JSON.parse(userData);
            log('DEBUG', 'Parsed user data', currentUser);
            fetchUserProfile(token);
        } catch (error) {
            log('ERROR', 'Failed to parse stored user data', error);
            clearSession();
        }
    } else {
        log('INFO', 'No stored session found - showing login form');
    }

    if (loginForm) loginForm.addEventListener('submit', handleLogin);
    if (registerForm) registerForm.addEventListener('submit', handleRegister);
    
    if (showRegisterLink) {
        showRegisterLink.addEventListener('click', (e) => {
            e.preventDefault();
            if(loginForm) loginForm.style.display = 'none';
            if(registerForm) registerForm.style.display = 'block';
        });
    }
    
    if (showLoginLink) {
        showLoginLink.addEventListener('click', (e) => {
            e.preventDefault();
            if(registerForm) registerForm.style.display = 'none';
            if(loginForm) loginForm.style.display = 'block';
        });
    }
});

// Session Management Functions
function clearSession() {
    log('INFO', 'clearSession ì‹œì‘');
    localStorage.removeItem('token');
    localStorage.removeItem('userData');
    currentUser = null;
    if (tokenRefreshInterval) {
        clearInterval(tokenRefreshInterval);
        tokenRefreshInterval = null;
    }
    stopAlarmPolling(); // ì•ŒëŒ í´ë§ ì¤‘ì§€
    window.location.reload();
}

function logout() {
    if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        clearSession();
    }
}

function startTokenRefresh() {
    log('INFO', 'Starting token refresh interval');
    if (tokenRefreshInterval) clearInterval(tokenRefreshInterval);
    tokenRefreshInterval = setInterval(refreshToken, 365 * 24 * 60 * 60 * 1000);
}

async function refreshToken() {
    const token = localStorage.getItem('token');
    if (!token) {
        log('WARN', 'No token found for refresh');
        return;
    }
    try {
        const response = await fetch('/token/refresh', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
        });
        if (response.ok) {
            const data = await response.json();
            localStorage.setItem('token', data.access_token);
            log('INFO', 'Token refreshed successfully');
        } else {
            log('ERROR', 'Token refresh failed', { status: response.status });
            clearSession();
        }
    } catch (error) {
        log('ERROR', 'Token refresh error', error);
        clearSession();
    }
}

// Authentication Functions
async function handleLogin(e) {
    e.preventDefault();
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    log('INFO', 'Login attempt', { username });
    try {
        const response = await fetch('/token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`,
        });
        if (response.ok) {
            const data = await response.json();
            if (data.access_token) {
                localStorage.setItem('token', data.access_token);
                log('INFO', 'Login successful');
                await fetchUserProfile(data.access_token);
            } else {
                log('ERROR', 'No access token in response');
                alert('ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„œë²„ ì‘ë‹µì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
        } else {
            const error = await response.json();
            // ... (error handling as before)
             if (response.status === 422) {
                log('ERROR', 'Login validation failed', error);
                const errorMessages = error.detail.map(
                    err => `[${err.loc ? err.loc.join('.') : ''}] ${err.msg}`
                );
                alert(`ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤:\n${errorMessages.join('\n')}`);
            } else {
                log('ERROR', 'Login failed', { status: response.status, error });
                alert(error.detail || 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì‚¬ìš©ì ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
            }
        }
    } catch (error) {
        log('ERROR', 'Login error', error);
        alert('ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

async function handleRegister(e) {
    e.preventDefault();
    const username = document.getElementById('reg-username').value;
    const name = document.getElementById('reg-name').value;
    const password = document.getElementById('reg-password').value;
    const confirmPassword = document.getElementById('reg-confirm-password').value;

    if (!username || !name || !password || !confirmPassword) {
        alert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return;
    }
    if (password !== confirmPassword) {
        alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return;
    }
    try {
        const payload = { username, name, password };
        const response = await fetch('/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        if (response.ok) {
            alert('íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
            showLoginForm();
        } else {
            const errorData = await response.json();
            // ... (error handling as before)
            if (response.status === 422) {
                log('ERROR', 'Registration validation failed', errorData);
                const errorMessages = errorData.detail.map(
                    err => `[${err.loc ? err.loc.join('.') : ''}] ${err.msg}`
                );
                alert(`ì…ë ¥ê°’ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤:\n${errorMessages.join('\n')}`);
            } else {
                log('ERROR', 'Registration failed', { status: response.status, error: errorData });
                alert(errorData.detail || 'íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
    } catch (error) {
        log('ERROR', 'Registration error', error);
        alert('íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

function showLoginForm() {
    if(registerForm) registerForm.style.display = 'none';
    if(loginForm) loginForm.style.display = 'block';
}

async function fetchUserProfile(token) {
    log('DEBUG', 'fetchUserProfile ì‹œì‘', { token: token ? 'exists' : 'missing' });
    if (!token) { clearSession(); return; }
    try {
        const response = await fetch('/users/me', {
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
        });
        if (response.ok) {
            const userData = await response.json();
            currentUser = userData;
            localStorage.setItem('userData', JSON.stringify(currentUser));
            showScheduleInterface();
            await loadSchedules();
            startTokenRefresh();
            startAlarmPolling(); // ì•ŒëŒ í´ë§ ì‹œì‘
        } else if (response.status === 401) {
            log('ERROR', 'Unauthorized in fetchUserProfile');
            clearSession();
        } else {
            log('ERROR', 'Failed to fetch user profile', { status: response.status });
            clearSession();
        }
    } catch (error) {
        log('ERROR', 'Network or other error in fetchUserProfile', error);
        clearSession();
    }
}

// Schedule Interface Functions
function showScheduleInterface() {
    log('INFO', 'showScheduleInterface ì‹œì‘');
    authContainer.innerHTML = `
        <details class="controls-collapsible">
            <summary class="controls-header">
                <h3>ì»¨íŠ¸ë¡¤</h3>
                <span class="toggle-icon">â–¼</span>
            </summary>
            <div class="controls">
                <button onclick="toggleCompletedFilter()">ì™„ë£Œ ì¼ì • ìˆ¨ê¸°ê¸°</button>
                <button onclick="toggleFileView()">íŒŒì¼ ë³´ê¸°</button> 
                <button onclick="exportToExcel()" class="excel-export-btn">
                    <i class="fas fa-file-excel"></i> ì—‘ì…€ë¡œ ì¶œë ¥
                </button>
                <button onclick="logout()" class="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </details>
        <details id="user-filter" class="user-filter-collapsible">
            <summary class="filter-header">
                <h3>ì‚¬ìš©ì í•„í„°</h3>
                <span class="toggle-icon">â–¼</span>
            </summary>
            <div class="filter-content">
                <div id="user-checkboxes"></div>
                <div class="schedule-info">
                    <span id="schedule-count">ì´ 0ê°œ ì¼ì •</span>
                    <span id="loading-indicator" style="display: none;">ë¡œë”© ì¤‘...</span>
                </div>
            </div>
        </details>
        <details id="alarm-collapsible" class="alarm-collapsible">
            <summary class="alarm-header-collapsible">
                <h3>ì•ŒëŒ</h3>
                <div class="alarm-header-actions">
                    <button onclick="clearAllAlarms()" class="clear-all-btn">ëª¨ë‘ ì§€ìš°ê¸°</button>
                    <span class="toggle-icon">â–¼</span>
                </div>
            </summary>
            <div class="alarm-container">
                <div id="alarm-list"><div class="no-alarms">ìƒˆë¡œìš´ ì•ŒëŒì´ ì—†ìŠµë‹ˆë‹¤.</div></div>
            </div>
        </details>
        <button onclick="showAddScheduleForm()" class="add-schedule-btn">ì¼ì • ì¶”ê°€</button>
        <div class="schedule-container" id="schedule-container">
            <table class="schedule-table">
                <thead><tr><th>ë‚ ì§œ</th><th>ì‘ì„±ì</th><th>ì œëª©</th></tr></thead>
                <tbody id="schedule-body"></tbody>
            </table>
        </div>
    `;
    loadUserCheckboxes();
    loadAlarms();
    setupInfiniteScroll();
    updateToggleCompletedButtonText();
    addDeleteAllButton(); // ëª¨ë“  ì¼ì • ì‚­ì œ ë²„íŠ¼ ì¶”ê°€
}

function setupInfiniteScroll() {
    const scheduleContainer = document.getElementById('schedule-container');
    if (!scheduleContainer) return;
    scheduleContainer.addEventListener('scroll', async () => {
        const { scrollTop, scrollHeight, clientHeight } = scheduleContainer;
        if (scrollTop + clientHeight >= scrollHeight * 0.9 && hasMoreSchedules && !isLoading) {
            currentPage++;
            showLoadingIndicator(true);
            await loadSchedules(currentPage, true); // append = true
            showLoadingIndicator(false);
        }
    });
}

function showLoadingIndicator(show) {
    const indicator = document.getElementById('loading-indicator');
    if (indicator) indicator.style.display = show ? 'inline' : 'none';
}

function updateScheduleCount() {
    const countElement = document.getElementById('schedule-count');
    if (countElement) {
        const visibleSchedules = schedules.filter(s => {
            if (!showCompleted && s.is_completed && !completedOnly) return false;
            if (completedOnly && !s.is_completed) return false;
            if (selectedUsers.size > 0 && !selectedUsers.has(s.owner_id)) return false;
            return true;
        });
        countElement.textContent = `í‘œì‹œ: ${visibleSchedules.length}ê°œ / ì „ì²´: ${schedules.length}ê°œ (DB)`;
    }
}

async function refreshSchedules() {
    log('DEBUG', 'refreshSchedules ì‹œì‘');
    currentPage = 1;
    hasMoreSchedules = true; // ë” ë§ì€ ìŠ¤ì¼€ì¤„ì´ ìˆì„ ìˆ˜ ìˆë‹¤ê³  ê°€ì •
    // schedules = []; // ë°”ë¡œ ë¹„ìš°ì§€ ì•Šê³ , loadSchedulesì—ì„œ append=falseë¡œ ì²˜ë¦¬
    await loadSchedules(1, false); // append = false
}

function updateToggleCompletedButtonText() {
    const button = document.querySelector('.controls button:first-child');
    if (!button) return;
    if (completedOnly) {
        button.textContent = 'ì§„í–‰ ì¼ì • ë³´ê¸°';
    } else if (!showCompleted) {
        button.textContent = 'ì™„ë£Œ ì¼ì •ë§Œ ë³´ê¸°';
    } else {
        button.textContent = 'ì™„ë£Œ ì¼ì • ìˆ¨ê¸°ê¸°';
    }
}

function toggleCompletedFilter() {
    if (showCompleted && !completedOnly) { // í˜„ì¬: ì™„ë£Œì¼ì • ìˆ¨ê¸°ê¸° ë²„íŠ¼ (ëª¨ë“  ì¼ì • í‘œì‹œ ì¤‘)
        showCompleted = true;
        completedOnly = true; // -> ì™„ë£Œ ì¼ì •ë§Œ ë³´ê¸°
    } else if (completedOnly) { // í˜„ì¬: ì™„ë£Œ ì¼ì •ë§Œ ë³´ê¸° ë²„íŠ¼
        showCompleted = true;
        completedOnly = false; // -> ëª¨ë“  ì¼ì • ë³´ê¸° (ì™„ë£Œì¼ì • ìˆ¨ê¸°ê¸° ë²„íŠ¼ìœ¼ë¡œ)
    } else { // í˜„ì¬: ì™„ë£Œ ì¼ì •ë§Œ ë³´ê¸° ë²„íŠ¼ (ì§„í–‰ ì¼ì •ë§Œ í‘œì‹œ ì¤‘ - !showCompleted)
        showCompleted = false; // -> ì™„ë£Œ ì¼ì • ìˆ¨ê¸°ê¸° (ì´ ìƒíƒœëŠ” showCompleted = false)
        completedOnly = false; // ì´ ìƒíƒœì—ì„œ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ 'ì™„ë£Œì¼ì •ë§Œ ë³´ê¸°'ë¡œ ê°€ì•¼í•˜ë¯€ë¡œ
                               // showCompleted = true, completedOnly = true ë¡œ ë³€ê²½ë˜ì–´ì•¼ í•¨.
                               // í•˜ì§€ë§Œ, ë°”ë¡œ ìœ„ì—ì„œ ì²˜ë¦¬í•˜ë¯€ë¡œ, ì—¬ê¸°ì„œëŠ” showCompleted = true, completedOnly = false ë¡œ ê°€ì„œ ëª¨ë“  ì¼ì •ì„ ë³´ì—¬ì£¼ëŠ” ê²ƒìœ¼ë¡œ.
                               // ë‹¤ì‹œ ìƒê°: ì´ ë²„íŠ¼ì€ 3ë‹¨ í† ê¸€.
                               // 1. ì™„ë£Œì¼ì • ìˆ¨ê¸°ê¸° (ëª¨ë‘ ë³´ì„, showCompleted=true, completedOnly=false)
                               // 2. ì™„ë£Œì¼ì •ë§Œ ë³´ê¸° (ì™„ë£Œë§Œ ë³´ì„, showCompleted=true, completedOnly=true)
                               // 3. ì§„í–‰ì¼ì •ë§Œ ë³´ê¸° (ì§„í–‰ë§Œ ë³´ì„, showCompleted=false, completedOnly=false)
        // ì´ ë¡œì§ì„ ë‹¨ìˆœí™” í•„ìš”. ë°±ì—”ë“œ íŒŒë¼ë¯¸í„°ë¥¼ ì§ì ‘ ì‚¬ìš©.
        // í˜„ì¬ ìƒíƒœ: (showCompleted=true, completedOnly=false) -> 'ì™„ë£Œì¼ì • ìˆ¨ê¸°ê¸°'
        // ë‹¤ìŒ ìƒíƒœ: (showCompleted=true, completedOnly=true) -> 'ì™„ë£Œì¼ì •ë§Œ ë³´ê¸°' (ë²„íŠ¼í…ìŠ¤íŠ¸: ì§„í–‰ì¼ì • ë³´ê¸°)
        // ë‹¤ìŒ ìƒíƒœ: (showCompleted=false, completedOnly=false) -> 'ì§„í–‰ì¼ì •ë§Œ ë³´ê¸°' (ë²„íŠ¼í…ìŠ¤íŠ¸: ì™„ë£Œì¼ì • ë³´ê¸°)

        // 3-state toggle: All -> Completed Only -> In-Progress Only -> All
        if (showCompleted && !completedOnly) { // State 1: All shown, button "ì™„ë£Œ ìˆ¨ê¸°ê¸°"
            // Go to State 2: Completed Only
            completedOnly = true;
        } else if (showCompleted && completedOnly) { // State 2: Completed Only shown, button "ì§„í–‰ ë³´ê¸°"
            // Go to State 3: In-Progress Only
            showCompleted = false;
            completedOnly = false;
        } else if (!showCompleted && !completedOnly) { // State 3: In-Progress Only shown, button "ì™„ë£Œ ë³´ê¸°"
            // Go to State 1: All
            showCompleted = true;
            completedOnly = false;
        }
    }
    updateToggleCompletedButtonText();
    refreshSchedules();
}


function toggleFileView() {
    const scheduleTable = document.querySelector('.schedule-container .schedule-table');
    const fileListView = document.querySelector('.schedule-container .file-list-view');
    const button = document.querySelector('.controls button:nth-child(3)');


    if (scheduleTable && scheduleTable.style.display !== 'none') { // ì¼ì • ë³´ê¸° ìƒíƒœ -> íŒŒì¼ ë³´ê¸°ë¡œ
        if (fileListView) {
            scheduleTable.style.display = 'none';
            fileListView.style.display = 'block';
        } else {
            showFileView(); // ì²˜ìŒì´ë©´ ìƒì„±
        }
        if(button) button.textContent = 'ì¼ì • ë³´ê¸°';
    } else { // íŒŒì¼ ë³´ê¸° ìƒíƒœ -> ì¼ì • ë³´ê¸°ë¡œ
        if (scheduleTable) {
            scheduleTable.style.display = 'table'; // tableë¡œ display ë³µì›
             if (fileListView) fileListView.style.display = 'none';
        }
        if(button) button.textContent = 'íŒŒì¼ ë³´ê¸°';
    }
}

async function showFileView() {
    const container = document.querySelector('.schedule-container');
    if (!container) return;
    
    const scheduleTable = container.querySelector('.schedule-table');
    if (scheduleTable) scheduleTable.style.display = 'none';

    let fileListView = container.querySelector('.file-list-view');
    if (!fileListView) {
        fileListView = document.createElement('div');
        fileListView.className = 'file-list-view'; // ìƒˆ í´ë˜ìŠ¤ ì´ë¦„
        fileListView.innerHTML = `<div class="file-list" id="file-list-main"></div>`; // ID ë³€ê²½
        container.appendChild(fileListView);
    }
    fileListView.style.display = 'block';
    await loadFilesForMainView(); // ìƒˆ í•¨ìˆ˜ í˜¸ì¶œ
}

async function loadFilesForMainView() { // ìƒˆ í•¨ìˆ˜
    try {
        const token = localStorage.getItem('token');
        if (!token) return;
        // API ì—”ë“œí¬ì¸íŠ¸ê°€ /schedules/attachments ì¸ì§€ /getschedules/-1 ì¸ì§€ í™•ì¸ í•„ìš”. ë°±ì—…ì—ì„œëŠ” /schedules/attachments ì‚¬ìš©.
        const response = await fetch('/schedules/attachments', { 
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
            const files = await response.json();
            renderFilesForMainView(files); // ìƒˆ í•¨ìˆ˜ í˜¸ì¶œ
        } else {
            log('ERROR', 'Failed to load files for main view', {status: response.status});
            const fileListMain = document.getElementById('file-list-main');
            if(fileListMain) fileListMain.innerHTML = '<p class="no-files">íŒŒì¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
        }
    } catch (error) {
        log('ERROR', 'File load error for main view', error);
        const fileListMain = document.getElementById('file-list-main');
        if(fileListMain) fileListMain.innerHTML = '<p class="no-files">íŒŒì¼ ëª©ë¡ ë¡œë”© ì¤‘ ì˜¤ë¥˜ ë°œìƒ.</p>';
    }
}

function renderFilesForMainView(files) { // ìƒˆ í•¨ìˆ˜
    const fileListMain = document.getElementById('file-list-main');
    if (!fileListMain) return;
    fileListMain.innerHTML = '';
    if (files.length === 0) {
        fileListMain.innerHTML = '<p class="no-files">ì²¨ë¶€ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
    }
    files.forEach(file => {
        const li = document.createElement('li');
        li.className = 'file-item';
        const createdDate = new Date(file.created_at).toLocaleString('ko-KR');
        li.innerHTML = `
            <div class="file-info">
                <span class="file-name">${file.file_name}</span>
                <span class="file-type">${file.file_type}</span>
                <span class="file-size">${formatFileSize(file.file_size || 0)}</span>
                <span class="file-date">${createdDate}</span>
                ${file.schedule_title ? `<span class="file-schedule">ê´€ë ¨ ì¼ì •: ${file.schedule_title}</span>` : ''}
            </div>
            <div class="file-actions">
                <button onclick="downloadFile('${file.file_path}')">ë‹¤ìš´ë¡œë“œ</button>
                <button onclick="deleteFileFromMainView(${file.id})">ì‚­ì œ</button> 
            </div>
        `;
        fileListMain.appendChild(li);
    });
}

async function deleteFileFromMainView(fileId) { // ìƒˆ í•¨ìˆ˜
    if (!confirm('ì •ë§ë¡œ ì´ íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
    const token = localStorage.getItem('token');
    if (!token) return;
    try {
        const response = await fetch(`/schedules/attachments/${fileId}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
            await loadFilesForMainView(); // íŒŒì¼ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        } else {
            const error = await response.json();
            log('ERROR', 'Failed to delete file from main view', error);
            alert(error.detail || 'íŒŒì¼ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        log('ERROR', 'File delete error from main view', error);
        alert('íŒŒì¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}


async function loadSchedules(page = 1, append = false) {
    if (isLoading && append) return; // ì¶”ê°€ ë¡œë“œ ì¤‘ì´ë©´ ì¤‘ë³µ ë°©ì§€
    isLoading = true;
    showLoadingIndicator(true);

    const token = localStorage.getItem('token');
    if (!token) { clearSession(); isLoading = false; showLoadingIndicator(false); return; }

    const params = new URLSearchParams({
        skip: (page - 1) * SCHEDULES_PER_PAGE,
        limit: SCHEDULES_PER_PAGE,
    });
    // í•„í„°ë§ ì¡°ê±´ ì¶”ê°€
    if (completedOnly) {
        params.append('completed_only', 'true');
    } else {
        params.append('show_completed', showCompleted.toString());
    }

    if (selectedUsers.size > 0) {
        selectedUsers.forEach(userId => params.append('user_ids', userId));
    }
    
    log('DEBUG', `Requesting schedules from: /schedules/?${params.toString()}`);

    try {
        const response = await fetch(`/schedules/?${params.toString()}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
            const data = await response.json(); // FastAPIê°€ ê°ì²´ {schedules: [], total_count: N}ë¥¼ ë°˜í™˜í•œë‹¤ê³  ê°€ì •
            const newSchedules = data.schedules || (Array.isArray(data) ? data : []); // í˜¸í™˜ì„±
            
            if (append) {
                schedules = schedules.concat(newSchedules);
            } else {
                schedules = newSchedules;
            }
            hasMoreSchedules = newSchedules.length === SCHEDULES_PER_PAGE;
            renderSchedules();
        } else if (response.status === 401) {
            clearSession();
        } else {
            log('ERROR', 'Failed to load schedules', {status: response.status});
        }
    } catch (error) {
        log('ERROR', 'Network or other error in loadSchedules', error);
    } finally {
        isLoading = false;
        showLoadingIndicator(false);
        updateScheduleCount();
    }
}

function renderSchedules() {
    const tbody = document.getElementById('schedule-body');
    if (!tbody) return;

    const fragment = document.createDocumentFragment();
    schedules.forEach(schedule => {
        // í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ í•„í„°ë§ (ì„ íƒ ì‚¬í•­, ë°±ì—”ë“œ í•„í„°ë§ì´ ì£¼ë ¥)
        if (completedOnly && !schedule.is_completed) return;
        if (!showCompleted && schedule.is_completed && !completedOnly) return;
        if (selectedUsers.size > 0 && !selectedUsers.has(schedule.owner_id)) return;

        const tr = document.createElement('tr');
        tr.className = schedule.is_completed ? 'completed' : '';
        tr.dataset.scheduleId = schedule.id; // data-schedule-id ì†ì„± ì¶”ê°€
        
        const priorityClassMap = { 'ê¸´ê¸‰': 'priority-urgent', 'ê¸‰í•¨': 'priority-high', 'ê³§ì„ë°•': 'priority-medium', 'ì¼ë°˜': 'priority-low', 'ê±°ë¶ì´': 'priority-turtle'};
        if (!schedule.is_completed && schedule.priority) {
            tr.classList.add(priorityClassMap[schedule.priority] || 'priority-low');
        }

        const dueTime = schedule.due_time ? new Date(schedule.due_time) : null;
        const now = getCurrentTime();
        if (dueTime && dueTime < now && !schedule.is_completed) {
            tr.classList.add('overdue');
        }
        
        function formatDateToMonthDay(dateStr) {
            //console.log('formatDateToMonthDay input:', dateStr);
            if (!dateStr) return '';
            const date = new Date(dateStr);
            //console.log('Parsed date:', date);
            const year = date.getFullYear().toString().slice(-2);
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const seconds = date.getSeconds().toString().padStart(2, '0');
            const result = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            //console.log('Formatted result:', result);
            return result;
        }
        function formatPriorityIcon(priority) {
            return priority === 'ê±°ë¶ì´' ? 'ğŸ¢' : (priorityMap[priority] || priority || '');
        }
        const priorityMap = {'ê¸´ê¸‰':'ğŸ”¥', 'ê¸‰í•¨':'â—', 'ê³§ì„ë°•':'âš ï¸', 'ì¼ë°˜':'âœ‰ï¸', 'ê±°ë¶ì´':'ğŸ¢'};

        // parent_orderê°€ ìˆìœ¼ë©´ ì œëª© ì•ì— ì¶”ê°€
        const titlePrefix = typeof schedule.parent_order !== 'undefined' ? `(${schedule.parent_order}) ` : '';
        const displayTitle = `${titlePrefix}${schedule.title}`;

        // ë‚ ì§œëŠ” ë‚ ì§œì™€ ë§ˆê°ì‹œê°„, ì´ˆê¹Œì§€ ëª¨ë‘ í‘œì‹œ í˜„ì¬ëŠ” ì´ˆê°€ í‘œì‹œ ì•ˆë¨
        tr.innerHTML = `
            <td data-label="ë‚ ì§œ">${schedule.due_time ? formatDateToMonthDay(schedule.due_time) : formatDateToMonthDay(schedule.date)}</td>
            <td data-label="ì‘ì„±ì">${schedule.owner ? schedule.owner.name : 'ì•Œìˆ˜ì—†ìŒ'}</td>
            <td data-label="ì œëª©">${formatPriorityIcon(schedule.priority)} ${displayTitle}</td>
        `;
        tr.addEventListener('click', () => handleScheduleClick(schedule)); // ë³€ê²½ëœ í•¨ìˆ˜ í˜¸ì¶œ
        
        // ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ (ìš°í´ë¦­ ë˜ëŠ” ê¸¸ê²Œ ëˆ„ë¥´ê¸°)
        tr.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            showContextMenu(e, schedule);
        });
        // (í„°ì¹˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ í•„ìš”)
        let touchTimer;
        tr.addEventListener('touchstart', (e) => {
            touchTimer = setTimeout(() => {
                e.preventDefault(); // ê¸°ë³¸ ë™ì‘ ë°©ì§€ (ì˜ˆ: í…ìŠ¤íŠ¸ ì„ íƒ)
                showContextMenu(e.touches[0], schedule);
            }, 700); // 700ms ê¸¸ê²Œ í„°ì¹˜
        });
        tr.addEventListener('touchend', () => clearTimeout(touchTimer));
        tr.addEventListener('touchmove', () => clearTimeout(touchTimer));


        fragment.appendChild(tr);
    });
    tbody.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì‚­ì œ
    tbody.appendChild(fragment);
    updateScheduleCount();
}


function showContextMenu(event, schedule) {
    hideContextMenu(); // ê¸°ì¡´ ë©”ë‰´ ì œê±°
    const menu = document.createElement('div');
    menu.className = 'context-menu';
    menu.innerHTML = `
        <div class="context-menu-item" onclick="showMemoPopup(${schedule.id})">ë©”ëª¨ì¶”ê°€/ìˆ˜ì •</div>
        <div class="context-menu-item" onclick="requestCompletion(${schedule.id})">ì™„ë£Œ ìš”ì²­</div>
        <div class="context-menu-item" onclick="handleScheduleClick(${JSON.stringify(schedule).replace(/"/g, '&quot;')})">ìƒì„¸ë³´ê¸°/ìˆ˜ì •</div>
    `;

    document.body.appendChild(menu);
    const menuWidth = menu.offsetWidth;
    const menuHeight = menu.offsetHeight;
    let x = event.clientX || event.pageX;
    let y = event.clientY || event.pageY;

    if (x + menuWidth > window.innerWidth) {
        x = window.innerWidth - menuWidth - 5;
    }
    if (y + menuHeight > window.innerHeight) {
        y = window.innerHeight - menuHeight - 5;
    }
    menu.style.left = `${x}px`;
    menu.style.top = `${y}px`;
    
    // ëª¨ë°”ì¼ í„°ì¹˜ ì´ë²¤íŠ¸ ì²˜ë¦¬ ê°œì„ 
    menu.addEventListener('touchstart', (e) => {
        e.stopPropagation(); // ì´ë²¤íŠ¸ ì „íŒŒ ì¤‘ë‹¨
    }, { passive: false });
    
    // ë©”ë‰´ ì•„ì´í…œì— ëŒ€í•œ í„°ì¹˜ ì´ë²¤íŠ¸ ì²˜ë¦¬
    const menuItems = menu.querySelectorAll('.context-menu-item');
    menuItems.forEach(item => {
        item.addEventListener('touchstart', (e) => {
            e.stopPropagation();
        }, { passive: false });
    });
    
    // ë©”ë‰´ ì™¸ë¶€ í„°ì¹˜ ì‹œ ë©”ë‰´ ë‹«ê¸°
    setTimeout(() => {
        document.addEventListener('touchstart', hideContextMenu, { once: true });
    }, 0);
}

function hideContextMenu() {
    const menu = document.querySelector('.context-menu');
    if (menu) menu.remove();
    document.removeEventListener('click', hideContextMenu);
    document.removeEventListener('touchstart', hideContextMenu);
}


async function requestCompletion(scheduleId) {
    const token = localStorage.getItem('token');
    if (!token) return;
    try {
        const response = await fetch(`/schedules/${scheduleId}/request-completion`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
        });
        if (response.ok) {
            alert('ì™„ë£Œ ìš”ì²­ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else if (response.status === 404 ) { // FastAPIì—ì„œ í•´ë‹¹ ê¸°ëŠ¥ ë¯¸êµ¬í˜„ ì‹œ 404 ë°˜í™˜ ê°€ì •
            alert('ì™„ë£Œ ìš”ì²­ ê¸°ëŠ¥ì´ ì•„ì§ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        } else {
            const error = await response.json();
            alert(error.detail || 'ì™„ë£Œ ìš”ì²­ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        log('ERROR', 'Request completion error', error);
        alert('ì™„ë£Œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
    hideContextMenu();
}


// --- MODAL RELATED FUNCTIONS ---
// Replaces showScheduleDetail, creates structure expected by editSchedule
function handleScheduleClick(schedule) {
    closeScheduleModal(); // Close any existing modal
 
    const modal = document.createElement('div');
    modal.className = 'schedule-modal';
    modal.dataset.scheduleId = schedule.id; // For deleteAttachment
    if (typeof schedule.parent_order !== 'undefined') {
        modal.dataset.parentOrder = schedule.parent_order;
    }
 
    // ë¶€ëª¨ ì¼ì • ì •ë³´ ì €ì¥
    window.lastParentTitle = schedule.title;
    window.lastParentContent = schedule.content;
    window.lastParentProjectName = schedule.project_name;
    window.lastParentPriority = schedule.priority;
 
    function formatDateModal(dateStr) {
        if (!dateStr) return 'ì—†ìŒ';
        return new Date(dateStr).toLocaleString('ko-KR', {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit', second: '2-digit'
        });
    }
 
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h2>${schedule.title}</h2>
                <button onclick="closeDetail()" class="close-button">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="schedule-detail">
                    <div class="schedule-info-table">
                        <div class="schedule-info-label">í”„ë¡œì íŠ¸ëª…</div>
                        <div class="schedule-info-value">${schedule.project_name || 'ì¼ì •'}</div>
                        <div class="schedule-info-label">ì¼ì •ëª…</div>
                        <div class="schedule-info-value">${schedule.title || 'ì¼ì •'}</div>
                        <div class="schedule-info-label">ì‘ì„±ì</div>
                        <div class="schedule-info-value">${schedule.owner ? schedule.owner.name : 'ì•Œ ìˆ˜ ì—†ìŒ'}</div>
                        
                        <div class="schedule-info-label">ë¶€ëª¨ì‘ì—…</div>
                        <div class="schedule-info-value">
                            ${schedule.parent ? schedule.parent.title : 'ì—†ìŒ'}
                        </div>
                        
                        <div class="schedule-info-label">ë‚ ì§œ</div>
                        <div class="schedule-info-value">${formatDateModal(schedule.date)}</div>
                        
                        <div class="schedule-info-label">ìš°ì„ ìˆœìœ„</div>
                        <div class="schedule-info-value">
                            <span class="priority-display priority-${schedule.priority || 'none'}">
                                ${schedule.priority || 'ì—†ìŒ'}
                            </span>
                        </div>
                        
                        <div class="schedule-info-label">ë§ˆê°ì‹œê°„</div>
                        <div class="schedule-info-value">${formatDateModal(schedule.due_time)}</div>
                        
                        <div class="schedule-info-label">ì•ŒëŒì‹œê°„</div>
                        <div class="schedule-info-value">${formatDateModal(schedule.alarm_time)}</div>
                        
                        <div class="schedule-info-label">ìƒíƒœ</div>
                        <div class="schedule-info-value">
                            <span class="${schedule.is_completed ? 'status-completed' : 'status-pending'}">
                                ${schedule.is_completed ? 'ì™„ë£Œ' : 'ë¯¸ì™„ë£Œ'}
                            </span>
                        </div>
                        
                        <div class="schedule-info-label">ë‚´ìš©</div>
                        <div class="schedule-info-value">
                            <div class="schedule-content-display">
                                ${schedule.content ? schedule.content.replace(/\n/g, '<br>') : 'ì—†ìŒ'}
                            </div>
                        </div>
                    </div>
                    
                    <div class="attachments-section">
                        <div class="attachments-header">ì²¨ë¶€ íŒŒì¼</div>
                        <div class="file-upload">
                            <input type="file" id="modal-file-upload" multiple>
                            <button onclick="uploadFilesToSchedule(${schedule.id})">ì—…ë¡œë“œ</button>
                        </div>
                        <div id="modal-attachments-list"></div>
                    </div>
                    
                    <div class="schedule-actions">
                        <button onclick="editSchedule(${schedule.id})">ìˆ˜ì •</button>
                        <button onclick="shareSchedule(${schedule.id})">ê³µìœ </button>
                        <button onclick="toggleComplete(${schedule.id}, ${!schedule.is_completed})">
                            ${schedule.is_completed ? 'ë¯¸ì™„ë£Œë¡œ' : 'ì™„ë£Œë¡œ'}
                        </button>
                        <button onclick="deleteSchedule(${schedule.id})" class="clear-all-btn">ì‚­ì œ</button>
                        <button onclick="createChildSchedule(${schedule.id})">í›„ì†ì‘ì—… ìƒì„±</button>
                        ${schedule.parent ? `<button onclick="viewParentSchedule(${schedule.parent.id})">ë¶€ëª¨ì‘ì—… ë³´ê¸°</button>` : ''}
                        ${schedule.children && schedule.children.length > 0 ? `<button onclick="viewChildrenSchedules(${schedule.id})">í›„ì†ì‘ì—… ë³´ê¸°</button>` : ''}
                    </div>
                    <div class="memo-section">
                        <div class="memo-header">ë©”ëª¨</div>
                        <div class="memo-container">
                            ${schedule.memo ? schedule.memo.split('\n').map(line => `<div class="memo-line">${line}</div>`).join('') : '<div class="memo-line">ì—†ìŒ</div>'}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    loadAttachmentsForModal(schedule.id);
}

// í›„ì† ì‘ì—… ê´€ë ¨ í•¨ìˆ˜ë“¤
async function createChildSchedule(parentId) {
    try {
        // 1. ìƒì„¸ ëª¨ë‹¬ì—ì„œ parentOrder ê°’ì„ ë¯¸ë¦¬ ì½ì–´ë‘ 
        const parentModal = document.getElementsByClassName('schedule-modal')[0];
        const parent_order = parentModal ? Number(parentModal.dataset.parentOrder) : 0;
        const childCount = parent_order + 1;

        // 2. ìƒì„¸ ëª¨ë‹¬ ë‹«ê¸°
        closeScheduleModal();

        // 3. ì¼ì • ì¶”ê°€ í¼ ë„ìš°ê¸°
        showAddScheduleForm();

        // 4. í¼ì´ ë Œë”ë§ëœ í›„ ê°’ì„ ì„¸íŒ…
        setTimeout(() => {
            // ì œëª©ì€ ë¹„ì›Œë‘ê³  placeholderë§Œ í‘œì‹œ
            document.getElementById('schedule-title').value = '';
            document.getElementById('schedule-content').value = window.lastParentContent || '';
            document.getElementById('schedule-project').value = window.lastParentProjectName || '';
            // ë¶€ëª¨ í”„ë¡œì íŠ¸ ì •ë³´ í‘œì‹œ
            const parentInfoDiv = document.getElementById('schedule-parent-info');
            if (parentInfoDiv) {
                parentInfoDiv.textContent = window.lastParentTitle || 'ì—†ìŒ';
            }
            // í˜„ì¬ ë‚ ì§œë¡œ ì„¤ì •
            const now = getCurrentTime();
            const nowDate = now.toISOString().split('T')[0];
            document.getElementById('schedule-date').value = nowDate;
            document.getElementById('schedule-priority').value = window.lastParentPriority || 'ì¼ë°˜';
            
            // ë¶€ëª¨ IDì™€ parent_orderë¥¼ hidden inputìœ¼ë¡œ ì €ì¥
            const form = document.getElementById('internal-add-schedule-form');
            if (form) {
                let parentIdInput = form.querySelector('#parent-id');
                if (!parentIdInput) {
                    parentIdInput = document.createElement('input');
                    parentIdInput.type = 'hidden';
                    parentIdInput.id = 'parent-id';
                    form.appendChild(parentIdInput);
                }
                parentIdInput.value = parentId;

                let parentOrderInput = form.querySelector('#parent-order');
                if (!parentOrderInput) {
                    parentOrderInput = document.createElement('input');
                    parentOrderInput.type = 'hidden';
                    parentOrderInput.id = 'parent-order';
                    form.appendChild(parentOrderInput);
                }
                parentOrderInput.value = childCount;
            }
        }, 100);
    } catch (error) {
        console.error('Create child schedule error:', error);
        alert(error.message);
    }
}

function closeDetail() {

    const detailDiv = document.querySelector('.schedule-modal');
    
    if (detailDiv) {
    
    detailDiv.remove();
    
    }
    
}

function closeScheduleModal() {
    const modal = document.querySelector('.schedule-modal');
    if (modal) {
        modal.remove();
    }
}

// --- ATTACHMENT FUNCTIONS FOR MODAL ---
async function loadAttachmentsForModal(scheduleId) {
    const token = localStorage.getItem('token');
    if (!token) return;
    const attachmentsList = document.getElementById('modal-attachments-list');
    if (!attachmentsList) return;
    attachmentsList.innerHTML = '<p>ì²¨ë¶€ íŒŒì¼ ë¡œë”© ì¤‘...</p>';

    try {
        // ìŠ¤ì¼€ì¤„ ìƒì„¸ ì •ë³´ë¥¼ ê°€ì ¸ì™€ì„œ attachmentsë¥¼ ì–»ì–´ì•¼ í•¨
        const response = await fetch(`/schedules/${scheduleId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
            const scheduleData = await response.json();
            renderAttachmentsForModal(scheduleData.attachments || [], scheduleId);
        } else {
            log('ERROR', 'Failed to load schedule details for attachments', {status: response.status});
            attachmentsList.innerHTML = '<p>ì²¨ë¶€ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
        }
    } catch (error) {
        log('ERROR', 'Load attachments error for modal', error);
        attachmentsList.innerHTML = '<p>ì²¨ë¶€ íŒŒì¼ ë¡œë”© ì¤‘ ì˜¤ë¥˜ ë°œìƒ.</p>';
    }
}

function renderAttachmentsForModal(attachments, scheduleId) {
    const attachmentsList = document.getElementById('modal-attachments-list');
    if (!attachmentsList) return;
    attachmentsList.innerHTML = '';
    if (attachments.length === 0) {
        attachmentsList.innerHTML = '<p>ì²¨ë¶€ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
    }
    attachments.forEach(attachment => {
        const attachmentDiv = document.createElement('div');
        attachmentDiv.className = 'attachment-item';
        attachmentDiv.innerHTML = `
            <div class="attachment-info">
                <a href="${attachment.file_path}" target="_blank" download="${attachment.file_name || 'download'}">
                  <span class="attachment-name">${attachment.file_name}</span>
                </a>
                <span class="attachment-size">${formatFileSize(attachment.file_size || 0)}</span>
            </div>
            <button onclick="deleteAttachmentFromModal(${attachment.id}, ${scheduleId})" class="delete-btn">ì‚­ì œ</button>
        `;
        attachmentsList.appendChild(attachmentDiv);
    });
}

async function uploadFilesToSchedule(scheduleId) {
    const token = localStorage.getItem('token');
    if (!token) return;
    const fileInput = document.getElementById('modal-file-upload');
    if (!fileInput || !fileInput.files.length) {
        alert('ì—…ë¡œë“œí•  íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    const formData = new FormData();
    for (const file of fileInput.files) {
        formData.append('file', file); // FastAPIì—ì„œëŠ” List[UploadFile] = File(...) ì´ë¯€ë¡œ 'files'
    }
    try {
        const response = await fetch(`/schedules/${scheduleId}/attachments`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }, // Content-Typeì€ FormDataê°€ ìë™ ì„¤ì •
            body: formData
        });
        if (response.ok) {
            await loadAttachmentsForModal(scheduleId); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            fileInput.value = ''; // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            alert('íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
            const error = await response.json();
            log('ERROR', 'File upload to schedule failed', error);
            alert(error.detail || 'íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        log('ERROR', 'File upload to schedule error', error);
        alert('íŒŒì¼ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

async function deleteAttachmentFromModal(attachmentId, scheduleId) {
    if (!confirm('ì •ë§ë¡œ ì´ ì²¨ë¶€ íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    const token = localStorage.getItem('token');
    if (!token) return;
    try {
        // API ì—”ë“œí¬ì¸íŠ¸ëŠ” /schedules/attachments/{attachment_id} ë˜ëŠ” /attachments/{attachment_id} ì¼ ìˆ˜ ìˆìŒ.
        // ë°±ì—…ì—ì„œëŠ” /schedules/attachments/{id} ì˜€ìŒ.
        const response = await fetch(`/schedules/attachments/${attachmentId}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
            await loadAttachmentsForModal(scheduleId); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            alert('ì²¨ë¶€ íŒŒì¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
            const error = await response.json();
            log('ERROR', 'Failed to delete attachment from modal', error);
            alert(error.detail || 'ì²¨ë¶€ íŒŒì¼ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        log('ERROR', 'Delete attachment error from modal', error);
        alert('ì²¨ë¶€ íŒŒì¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}


// --- SCHEDULE CRUD FUNCTIONS (ADD, EDIT, DELETE, COMPLETE, SHARE, MEMO from backup) ---
async function toggleComplete(scheduleId, completed) { // completed íŒŒë¼ë¯¸í„°ëŠ” í˜„ì¬ ìƒíƒœì˜ ë°˜ëŒ€.
    log('DEBUG', 'Toggling schedule completion', { scheduleId, toState: completed });
    const token = localStorage.getItem('token');
    if (!token) return;
    try {
        // APIê°€ is_completed ê°’ì„ ë°›ëŠ”ì§€, ì•„ë‹ˆë©´ ê·¸ëƒ¥ í† ê¸€ì¸ì§€ í™•ì¸ í•„ìš”.
        // FastAPIì—ì„œëŠ” ë³´í†µ PUT /schedules/{id}/complete ë˜ëŠ” /schedules/{id}/incomplete
        // ë˜ëŠ” POST /schedules/{id}/toggle_complete
        // ì—¬ê¸°ì„œëŠ” POST /schedules/{id}/complete ê°€ í† ê¸€ ì—­í• ì„ í•œë‹¤ê³  ê°€ì • (ë°±ì—…ê³¼ ë™ì¼)
        const response = await fetch(`/schedules/${scheduleId}/complete`, {
            method: 'POST', // ë˜ëŠ” PUT
            headers: { 'Authorization': `Bearer ${token}` /*, 'Content-Type': 'application/json' */},
            // body: JSON.stringify({ is_completed: completed }) // APIê°€ ìƒíƒœë¥¼ ë°›ëŠ” ê²½ìš°
        });
        if (response.ok) {
            log('INFO', 'Schedule completion toggled successfully');
            // ëª¨ë‹¬ì´ ì—´ë ¤ìˆìœ¼ë©´ ëª¨ë‹¬ ë‚´ ì •ë³´ ì—…ë°ì´íŠ¸, ì•„ë‹ˆë©´ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            const modal = document.querySelector('.schedule-modal');
            if (modal && modal.dataset.scheduleId == scheduleId) {
                 // íŠ¹ì • ìŠ¤ì¼€ì¤„ ë°ì´í„°ë§Œ ë‹¤ì‹œ ë¡œë“œí•˜ì—¬ ëª¨ë‹¬ ì—…ë°ì´íŠ¸
                const updatedScheduleData = await response.json(); // APIê°€ ì—…ë°ì´íŠ¸ëœ ìŠ¤ì¼€ì¤„ ë°˜í™˜ ê°€ì •
                const scheduleIndex = schedules.findIndex(s => s.id === scheduleId);
                if (scheduleIndex !== -1) schedules[scheduleIndex] = updatedScheduleData;
                handleScheduleClick(updatedScheduleData); // ëª¨ë‹¬ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
            } else {
                 await refreshSchedules(); // ì „ì²´ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            }
        } else {
            const error = await response.json();
            log('ERROR', 'Failed to toggle schedule completion', error);
            alert(error.detail || 'ì¼ì • ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        log('ERROR', 'Toggle complete error', error);
        alert('ì¼ì • ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

async function showAddScheduleForm() {
    // ê¸°ì¡´ í¼ì´ ìˆìœ¼ë©´ ì œê±°
    cancelAddSchedule();

    const now = getCurrentTime();
    const nowDate = now.toISOString().split('T')[0];
    const nowDateTime = now.toISOString().slice(0, 16);

    const formDiv = document.createElement('div');
    formDiv.className = 'add-schedule-form';

    formDiv.style.position = 'fixed';
    formDiv.style.top = '0';
    formDiv.style.left = '0';
    formDiv.style.width = '100vw';
    formDiv.style.height = '100vh';
    formDiv.style.backgroundColor = 'rgba(0, 0, 0, 0.6)';
    formDiv.style.zIndex = '1000';
    formDiv.style.display = 'flex';
    formDiv.style.justifyContent = 'center';
    formDiv.style.alignItems = 'center';
    formDiv.style.padding = '20px';
    formDiv.style.boxSizing = 'border-box';

    formDiv.innerHTML = `
        <form id="internal-add-schedule-form" style="background-color: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; box-sizing: border-box;">
            <h3 style="text-align: center; margin-top: 0; margin-bottom: 20px; color: #333;">ìƒˆ ì¼ì • ì¶”ê°€</h3>
            
            <div class="form-group" style="position: relative;">
                <label for="schedule-project">í”„ë¡œì íŠ¸ëª… *</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="schedule-project" placeholder="í”„ë¡œì íŠ¸ëª…ì„ ì…ë ¥í•˜ì„¸ìš” (ë¯¸ì…ë ¥ì‹œ 'ì¼ì •'ìœ¼ë¡œ í‘œì‹œ)" style="flex: 1;">
                    <button type="button" onclick="toggleProjectList()" style="padding: 5px 10px;">â–¼</button>
                </div>
                <div id="project-list" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 1000;"></div>
            </div>

            <div class="form-group">
                <label for="schedule-title">ì œëª© *</label>
                <input type="text" id="schedule-title" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš” (ë¯¸ì…ë ¥ì‹œ 'ì¼ì •'ìœ¼ë¡œ í‘œì‹œ)">
            </div>

            <div class="form-group">
                <label for="schedule-parent">ë¶€ëª¨ì‘ì—…</label>
                <div id="schedule-parent-info" style="">
                    ì—†ìŒ
                </div>
            </div>

            <div class="form-group">
                <label for="schedule-date">ë‚ ì§œ *</label>
                <input type="date" id="schedule-date" value="${nowDate}" required>
            </div>

            <div class="form-group">
                <label for="schedule-priority">ìš°ì„ ìˆœìœ„ *</label>
                <select id="schedule-priority" required>
                    <option value="ê¸´ê¸‰">ê¸´ê¸‰</option>
                    <option value="ê¸‰í•¨">ê¸‰í•¨</option>
                    <option value="ê³§ì„ë°•">ê³§ì„ë°•</option>
                    <option value="ì¼ë°˜" selected>ì¼ë°˜</option>
                    <option value="ê±°ë¶ì´">ğŸ¢ ê±°ë¶ì´</option>
                </select>
            </div>

            <div class="form-group">
                <label for="schedule-content">ë‚´ìš©</label>
                <textarea id="schedule-content" placeholder="ë‚´ìš©" rows="3"></textarea>
            </div>

            <div class="form-group">
                <label for="schedule-due-time">ë§ˆê°ì‹œê°„</label>
                <input type="datetime-local" id="schedule-due-time" value="${nowDateTime}" step="1">
            </div>

            <div class="form-group">
                <label for="schedule-alarm-time">ì•ŒëŒì‹œê°„</label>
                <input type="datetime-local" id="schedule-alarm-time" value="${nowDateTime}" step="1">
            </div>

            <div class="form-group">
                <label>ì•ŒëŒ ë¹ ë¥¸ ì„¤ì •</label>
                <div class="alarm-quick-buttons">
                    <button type="button" onclick="setQuickAlarmTime(1)">1ì‹œê°„ ì „</button>
                    <button type="button" onclick="setQuickAlarmTime(3)">3ì‹œê°„ ì „</button>
                    <button type="button" onclick="setQuickAlarmTime(24)">í•˜ë£¨ ì „</button>
                    <button type="button" id="repeat-toggle" onclick="toggleRepeatInForm()">ë§¤ì¼ ë°˜ë³µ</button>
                    <input type="hidden" id="schedule-repeat" value="false">
                </div>
            </div>

            <div class="form-buttons" style="text-align: right; margin-top: 20px;">
                <button type="submit">ì¶”ê°€</button>
                <button type="button" onclick="cancelAddSchedule()" style="padding: 10px 15px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">ì·¨ì†Œ</button>
            </div>
        </form>
    `;

    document.body.appendChild(formDiv);

    const internalForm = formDiv.querySelector('#internal-add-schedule-form');
    if(internalForm) {
        internalForm.addEventListener('submit', handleAddSchedule);
        const dateInput = internalForm.querySelector('#schedule-date');
        if(dateInput) {
            dateInput.addEventListener('change', updateTimesOnDateChangeInForm);
        }
    }

    const firstInput = formDiv.querySelector('#schedule-project');
    if (firstInput) {
        firstInput.focus();
    }

    // í”„ë¡œì íŠ¸ ëª©ë¡ ë¡œë“œ
    await loadProjectList();
}

function toggleProjectList() {
    const projectList = document.getElementById('project-list');
    if (projectList) {
        projectList.style.display = projectList.style.display === 'none' ? 'block' : 'none';
    }
}

// í”„ë¡œì íŠ¸ ì…ë ¥ í•„ë“œ ì™¸ë¶€ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
document.addEventListener('click', (e) => {
    const projectList = document.getElementById('project-list');
    const projectInput = document.getElementById('schedule-project');
    const toggleButton = e.target.closest('button[onclick="toggleProjectList()"]');
    
    if (projectList && projectList.style.display !== 'none' && 
        !projectList.contains(e.target) && 
        !projectInput.contains(e.target) && 
        !toggleButton) {
        projectList.style.display = 'none';
    }
});

async function updateTimesOnDateChangeInForm() {
    const selectedDate = document.getElementById('schedule-date').value;
    if (!selectedDate) return;
    const now = getCurrentTime();
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');
    const newDateTime = `${selectedDate}T${hours}:${minutes}:${seconds}`;
    const dueTimeInput = document.getElementById('schedule-due-time');
    const alarmTimeInput = document.getElementById('schedule-alarm-time');
    if (dueTimeInput) dueTimeInput.value = newDateTime;
    if (alarmTimeInput) alarmTimeInput.value = newDateTime;
}

async function setQuickAlarmTime(hoursBefore) {
    console.log('setQuickAlarmTime0', hoursBefore);
    const dueTimeInput = document.getElementById('schedule-due-time');
    const alarmTimeInput = document.getElementById('schedule-alarm-time');
    if (!dueTimeInput || !alarmTimeInput || !dueTimeInput.value) {
        alert('ë¨¼ì € ë§ˆê°ì‹œê°„ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.'); return;
    }
    
    // ë§ˆê°ì‹œê°„ì„ Date ê°ì²´ë¡œ ë³€í™˜
    console.log('setQuickAlarmTime1', dueTimeInput);
    const dueTime = new Date(dueTimeInput.value);
    if (isNaN(dueTime.getTime())) { 
        alert('ìœ íš¨í•œ ë§ˆê°ì‹œê°„ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.'); 
        return; 
    }
    
    // ì•ŒëŒ ì‹œê°„ ê³„ì‚° (ë§ˆê°ì‹œê°„ì—ì„œ hoursBefore ì‹œê°„ì„ ëºŒ)
    const alarmTime = new Date(dueTime.getTime() - (hoursBefore * 60 * 60 * 1000));
    console.log('setQuickAlarmTime2', alarmTime);
    
    // datetime-local ì…ë ¥ í•„ë“œ í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (YYYY-MM-DDTHH:mm)
    const year = alarmTime.getFullYear();
    const month = String(alarmTime.getMonth() + 1).padStart(2, '0');
    const day = String(alarmTime.getDate()).padStart(2, '0');
    const hours = String(alarmTime.getHours()).padStart(2, '0');
    const minutes = String(alarmTime.getMinutes()).padStart(2, '0');
    const alarmDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
    console.log('setQuickAlarmTime3', alarmDateTime);
    alarmTimeInput.value = alarmDateTime;
}

function toggleRepeatInForm() { // For Add Form
    const repeatButton = document.getElementById('repeat-toggle');
    const repeatInput = document.getElementById('schedule-repeat');
    if (!repeatButton || !repeatInput) return;
    if (repeatInput.value === 'false') {
        repeatInput.value = 'true';
        repeatButton.textContent = 'ë§¤ì¼ ë°˜ë³µ í•´ì œ';
        repeatButton.classList.add('active');
    } else {
        repeatInput.value = 'false';
        repeatButton.textContent = 'ë§¤ì¼ ë°˜ë³µ';
        repeatButton.classList.remove('active');
    }
}

function cancelAddSchedule() {
    const form = document.querySelector('.add-schedule-form');
    if (form) form.remove();
}

async function handleAddSchedule(e) {
    e.preventDefault();
    const token = localStorage.getItem('token');
    if (!token) return;

    function formatDateTimeForAPI(dateStr) {
        if (!dateStr) return null;
        const date = new Date(dateStr);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const seconds = String(date.getSeconds()).padStart(2, '0');
        return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}`;
    }

    const projectInput = document.getElementById('schedule-project');
    const titleInput = document.getElementById('schedule-title');
    const project = projectInput.value.trim() || 'ì¼ì •';
    const title = titleInput.value.trim() || 'ì¼ì •';
    const date = document.getElementById('schedule-date').value;
    const priority = document.getElementById('schedule-priority').value;
    if (!date || !priority) {
        alert('ë‚ ì§œì™€ ìš°ì„ ìˆœìœ„ëŠ” í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.'); return;
    }

    // ë¶€ëª¨ IDì™€ parent_order ê°€ì ¸ì˜¤ê¸°
    const parentIdInput = document.getElementById('parent-id');
    const parentOrderInput = document.getElementById('parent-order');
    const parent_id = parentIdInput && parentIdInput.value ? parseInt(parentIdInput.value) : null;
    const parent_order = parentOrderInput && parentOrderInput.value ? parseInt(parentOrderInput.value) : 0;

    // ìƒˆë¡œìš´ í”„ë¡œì íŠ¸ëª…ì¸ ê²½ìš° projects.jsonì— ì¶”ê°€
    if (project !== 'ì¼ì •') {
        try {
            const response = await fetch('/projects/', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: project })
            });
            if (!response.ok) {
                const error = await response.json();
                // ì´ë¯¸ ì¡´ì¬í•˜ëŠ” í”„ë¡œì íŠ¸ëª…ì¸ ê²½ìš°ëŠ” ë¬´ì‹œ
                if (error.detail !== "ì´ë¯¸ ì¡´ì¬í•˜ëŠ” í”„ë¡œì íŠ¸ì…ë‹ˆë‹¤") {
                    throw new Error(error.detail);
                }
            }
        } catch (error) {
            log('ERROR', 'Add project error', error);
            // í”„ë¡œì íŠ¸ ì¶”ê°€ ì‹¤íŒ¨ëŠ” ì¼ì • ìƒì„±ì— ì˜í–¥ì„ ì£¼ì§€ ì•Šë„ë¡ í•¨
        }
    }

    const scheduleData = {
        project_name: project,
        title: title,
        date: formatDateTimeForAPI(date),
        priority: priority,
        content: document.getElementById('schedule-content').value || null,
        due_time: formatDateTimeForAPI(document.getElementById('schedule-due-time').value),
        alarm_time: formatDateTimeForAPI(document.getElementById('schedule-alarm-time').value),
        is_repeat: document.getElementById('schedule-repeat').value === 'true',
        parent_id: parent_id,
        parent_order: parent_order
    };

    try {
        const response = await fetch('/schedules/', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify(scheduleData),
        });
        if (response.ok) {
            cancelAddSchedule();
            await refreshSchedules();
            // í”„ë¡œì íŠ¸ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            await loadProjectList();
        } else {
            const error = await response.json();
            log('ERROR', 'Schedule creation error', error);
            alert(error.detail || 'ì¼ì • ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        log('ERROR', 'Add schedule error', error);
        alert('ì¼ì • ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// Provided editSchedule by user
async function editSchedule(scheduleId) {
    const schedule = schedules.find(s => s.id === scheduleId);
    if (!schedule) { log('ERROR', `Schedule with id ${scheduleId} not found for editing.`); return; }
 
    const modal = document.querySelector('.schedule-modal');
    if (!modal) {
        alert("ì˜¤ë¥˜: ìˆ˜ì • ëŒ€ìƒ ëª¨ë‹¬ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }
 
    const form = document.createElement('div');
    form.className = 'edit-form';
    
    const scheduleDate = schedule.date ? new Date(schedule.date).toISOString().split('T')[0] : '';
    const scheduleDueTime = schedule.due_time ? new Date(schedule.due_time).toISOString().slice(0, 16) : '';
    const scheduleAlarmTime = schedule.alarm_time ? new Date(schedule.alarm_time).toISOString().slice(0, 16) : '';

    form.innerHTML = `
        <form id="internal-edit-schedule-form">
            <h4>ì¼ì • ìˆ˜ì •</h4>
            <div class="form-group">
                <label for="edit-title">ì œëª© *</label>
                <input type="text" id="edit-title" value="${schedule.title}" required>
            </div>
            <div class="form-group">
                <label for="edit-date">ë‚ ì§œ *</label>
                <input type="date" id="edit-date" value="${scheduleDate}" required>
            </div>
            <div class="form-group">
                <label for="edit-priority">ìš°ì„ ìˆœìœ„ *</label>
                <select id="edit-priority" required>
                    <option value="ê¸´ê¸‰" ${schedule.priority === 'ê¸´ê¸‰' ? 'selected' : ''}>ê¸´ê¸‰</option>
                    <option value="ê¸‰í•¨" ${schedule.priority === 'ê¸‰í•¨' ? 'selected' : ''}>ê¸‰í•¨</option>
                    <option value="ê³§ì„ë°•" ${schedule.priority === 'ê³§ì„ë°•' ? 'selected' : ''}>ê³§ì„ë°•</option>
                    <option value="ì¼ë°˜" ${schedule.priority === 'ì¼ë°˜' ? 'selected' : ''}>ì¼ë°˜</option>
                    <option value="ê±°ë¶ì´" ${schedule.priority === 'ê±°ë¶ì´' ? 'selected' : ''}>ğŸ¢ ê±°ë¶ì´</option>
                </select>
            </div>
            <div class="form-group">
                <label for="edit-content">ë‚´ìš©</label>
                <textarea id="edit-content">${schedule.content || ''}</textarea>
            </div>
            <div class="form-group">
                <label for="edit-due-time">ë§ˆê°ì‹œê°„</label>
                <input type="datetime-local" id="edit-due-time" value="${scheduleDueTime}">
            </div>
            <div class="form-group">
                <label for="edit-alarm-time">ì•ŒëŒì‹œê°„</label>
                <input type="datetime-local" id="edit-alarm-time" value="${scheduleAlarmTime}">
            </div>
            <button type="submit">ì €ì¥</button>
            <button type="button" onclick="cancelEdit(${scheduleId})">ì·¨ì†Œ</button>
        </form>
    `;
 
    // *** ì´ ë¶€ë¶„ì„ ì œê±° - ìƒì„¸ ì •ë³´ë¥¼ ìˆ¨ê¸°ì§€ ì•ŠìŒ ***
    // const scheduleDetailDiv = modal.querySelector('.schedule-detail');
    // if (scheduleDetailDiv) scheduleDetailDiv.style.display = 'none';
 
    // ì•¡ì…˜ ë²„íŠ¼ë§Œ ìˆ˜ì • ëª¨ë“œìš©ìœ¼ë¡œ ë³€ê²½
    const scheduleActionsDiv = modal.querySelector('.schedule-actions');
    if (scheduleActionsDiv) {
        scheduleActionsDiv.innerHTML = `
            <button onclick="deleteSchedule(${schedule.id})" class="clear-all-btn">ì‚­ì œ</button>
            <button onclick="shareSchedule(${schedule.id})">ê³µìœ </button>
            <button onclick="cancelEdit(${scheduleId})">ìˆ˜ì • ì·¨ì†Œ</button> 
        `;
    }
 
    const modal_header = modal.querySelector('.modal-content');
    const modalBody = modal.querySelector('.schedule-detail');
    if (modal_header) {
        const existingEditForm = modal_header.querySelector('.edit-form');
        if (existingEditForm) existingEditForm.remove();
        modal_header.appendChild(form); // ìƒì„¸ ì •ë³´ ì•„ë˜ì— ìˆ˜ì • í¼ ì¶”ê°€
        //hide modalBody
        modalBody.style.display = 'none';
    } else {
        alert("ìˆ˜ì • í¼ì„ í‘œì‹œí•˜ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        return;
    }
 
    form.querySelector('#internal-edit-schedule-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        await updateSchedule(scheduleId);
    });
}

// cancelEdit from backup
function cancelEdit(scheduleId) {
    const modal = document.querySelector('.schedule-modal');
    if (!modal) return;
    
    const editForm = modal.querySelector('.edit-form');
    if (editForm) editForm.remove();

    const schedule = schedules.find(s => s.id === scheduleId);
    if (!schedule) return;

    const scheduleActionsDiv = modal.querySelector('.schedule-actions');
    const modalBody = modal.querySelector('.schedule-detail');
    if (modalBody) modalBody.style.display = 'block';
    if (scheduleActionsDiv) {
        scheduleActionsDiv.innerHTML = `
            <button onclick="editSchedule(${schedule.id})">ìˆ˜ì •</button>
            <button onclick="shareSchedule(${schedule.id})">ê³µìœ </button>
            <button onclick="toggleComplete(${schedule.id}, ${!schedule.is_completed})">
                ${schedule.is_completed ? 'ë¯¸ì™„ë£Œë¡œ' : 'ì™„ë£Œë¡œ'}
            </button>
            <button onclick="deleteSchedule(${schedule.id})" class="clear-all-btn">ì‚­ì œ</button>
        `;
    }
}

// updateSchedule from backup
async function updateSchedule(scheduleId) {
    const token = localStorage.getItem('token');
    if (!token) return;

    function formatDateTimeForAPI(dateStr) {
        if (!dateStr) return null;
        const date = new Date(dateStr);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const seconds = String(date.getSeconds()).padStart(2, '0');
        return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}`;
    }

    const updatedData = {
        title: document.getElementById('edit-title').value,
        date: formatDateTimeForAPI(document.getElementById('edit-date').value),
        priority: document.getElementById('edit-priority').value,
        content: document.getElementById('edit-content').value || null,
        due_time: formatDateTimeForAPI(document.getElementById('edit-due-time').value),
        alarm_time: formatDateTimeForAPI(document.getElementById('edit-alarm-time').value),
    };

    try {
        const response = await fetch(`/schedules/${scheduleId}`, {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify(updatedData),
        });
        if (response.ok) {
            closeScheduleModal();
            await refreshSchedules();
        } else {
            const error = await response.json();
            log('ERROR', 'Failed to update schedule', error);
            alert(error.detail || 'ì¼ì • ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        log('ERROR', 'Update schedule error', error);
        alert('ì¼ì • ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

async function deleteSchedule(scheduleId) {
    if (!confirm('ì •ë§ë¡œ ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
    const token = localStorage.getItem('token');
    if (!token) return;
    try {
        const response = await fetch(`/schedules/${scheduleId}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
            closeScheduleModal();
            await refreshSchedules(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            alert('ì¼ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
            const error = await response.json();
            log('ERROR', 'Failed to delete schedule', error);
            alert(error.detail || 'ì¼ì • ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        log('ERROR', 'Delete schedule error', error);
        alert('ì¼ì • ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// shareSchedule and shareScheduleWithUser from backup
async function shareSchedule(scheduleId) {
    const token = localStorage.getItem('token');
    if (!token) return;

    try {
        const usersResponse = await fetch('/users/', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!usersResponse.ok) throw new Error('Failed to fetch users for sharing.');
        
        const users = await usersResponse.json();
        const currentUserData = JSON.parse(localStorage.getItem('userData'));
        const otherUsers = users.filter(user => user.id !== currentUserData.id);

        if (otherUsers.length === 0) {
            alert('ê³µìœ í•  ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.'); return;
        }

        const modalBody = document.querySelector('.schedule-modal .modal-body');
        if (!modalBody) { alert('ê³µìœ  í¼ì„ í‘œì‹œí•  ìœ„ì¹˜ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'); return; }

        // ê¸°ì¡´ ê³µìœ  í¼ ì œê±°
        const existingShareForm = modalBody.querySelector('.share-schedule-form-container');
        if (existingShareForm) existingShareForm.remove();

        const formContainer = document.createElement('div');
        formContainer.className = 'share-schedule-form-container'; // For styling and removal
        formContainer.innerHTML = `
            <form id="internal-share-schedule-form">
                <h4>ì¼ì • ê³µìœ </h4>
                <div class="form-group">
                    <label for="share-user">ê³µìœ í•  ì‚¬ìš©ì</label>
                    <select id="share-user" required>
                        ${otherUsers.map(user => `<option value="${user.id}">${user.name} (${user.username})</option>`).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label for="share-memo">ë©”ëª¨ (ì„ íƒ)</label>
                    <textarea id="share-memo" placeholder="ê³µìœ  ì‹œ ì „ë‹¬í•  ë©”ëª¨"></textarea>
                </div>
                <div class="form-buttons">
                    <button type="submit">ê³µìœ  ì‹¤í–‰</button>
                    <button type="button" onclick="this.closest('.share-schedule-form-container').remove()">ì·¨ì†Œ</button>
                </div>
            </form>
        `;
        // ìƒì„¸ì •ë³´ì™€ ì•¡ì…˜ë²„íŠ¼ ì‚¬ì´ì— í¼ ì‚½ì… ë˜ëŠ” íŠ¹ì • ìœ„ì¹˜ì— append
        const scheduleDetailDiv = modalBody.querySelector('.schedule-detail');
        if (scheduleDetailDiv) {
            scheduleDetailDiv.parentNode.insertBefore(formContainer, scheduleDetailDiv.nextSibling); // ìƒì„¸ì •ë³´ ë‹¤ìŒì— ì‚½ì…
        } else {
            modalBody.appendChild(formContainer); // fallback
        }
        
        formContainer.querySelector('#internal-share-schedule-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            await shareScheduleWithUser(scheduleId);
            formContainer.remove(); // ì„±ê³µ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ í¼ ì œê±°
        });

    } catch (error) {
        log('ERROR', 'Share schedule setup error', error);
        alert('ê³µìœ  ê¸°ëŠ¥ ì¤€ë¹„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
    }
}

async function shareScheduleWithUser(scheduleId) {
    const token = localStorage.getItem('token');
    if (!token) return;
    const sharedWithId = document.getElementById('share-user').value;
    const memo = document.getElementById('share-memo').value || null;

    const shareData = {
        schedule_id: scheduleId, // API ìŠ¤í‚¤ë§ˆì— ë”°ë¼ í•„ë“œëª… í™•ì¸
        shared_with_id: parseInt(sharedWithId),
        memo: memo
    };
    log('DEBUG', 'Sharing schedule data', shareData);

    try {
        // API ì—”ë“œí¬ì¸íŠ¸: /schedules/{schedule_id}/share ë˜ëŠ” /shares/
        const response = await fetch(`/schedules/${scheduleId}/share`, { 
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify(shareData),
        });
        if (response.ok) {
            alert('ì¼ì •ì´ ì„±ê³µì ìœ¼ë¡œ ê³µìœ ë˜ì—ˆìŠµë‹ˆë‹¤.');
            // ê³µìœ  í›„ íŠ¹ë³„í•œ UI ë³€ê²½ì´ í•„ìš”í•˜ë©´ ì—¬ê¸°ì— ì¶”ê°€ (ì˜ˆ: ì•Œë¦¼ ìƒì„±)
        } else if (response.status === 404 && (await response.json()).detail === "Share endpoint not implemented yet") {
            alert("ê³µìœ  ê¸°ëŠ¥ì´ ì•„ì§ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        }
         else {
            const error = await response.json();
            log('ERROR', 'Failed to share schedule', error);
            alert(error.detail || 'ì¼ì • ê³µìœ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        log('ERROR', 'Share schedule execution error', error);
        alert('ì¼ì • ê³µìœ  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// showMemoPopup and updateMemo from backup
function showMemoPopup(scheduleId) {
    hideContextMenu(); // ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ëŠ” ë‹«ê¸°
    const schedule = schedules.find(s => s.id === scheduleId);
    if (!schedule) { alert('ë©”ëª¨ë¥¼ ì¶”ê°€í•  ì¼ì •ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'); return;}

    // ê¸°ì¡´ ë©”ëª¨ ëª¨ë‹¬ì´ ìˆë‹¤ë©´ ì œê±°
    const existingMemoModal = document.querySelector('.memo-modal-overlay');
    if (existingMemoModal) existingMemoModal.remove();

    const memoModalOverlay = document.createElement('div');
    memoModalOverlay.className = 'memo-modal-overlay'; // ì „ì²´ í™”ë©´ ì–´ë‘¡ê²Œ
    
    memoModalOverlay.innerHTML = `
        <div class="memo-modal-content">
            <div class="modal-header">
                <h3>ë©”ëª¨ ì¶”ê°€</h3>
                <button class="close-button" onclick="this.closest('.memo-modal-overlay').remove()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="internal-memo-form">
                    <div class="form-group">
                        <label for="memo-text-content">ë©”ëª¨ ë‚´ìš©</label>
                        <textarea id="memo-text-content" rows="5" placeholder="ì—¬ê¸°ì— ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                    </div>
                    <div class="form-buttons">
                        <button type="submit">ì¶”ê°€</button>
                        <button type="button" onclick="this.closest('.memo-modal-overlay').remove()">ì·¨ì†Œ</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    
    // ì¼ì • ì¶”ê°€ ë²„íŠ¼ ì°¾ê¸°
    const addScheduleBtn = document.querySelector('.add-schedule-btn');
    if (addScheduleBtn) {
        // ì¼ì • ì¶”ê°€ ë²„íŠ¼ ë‹¤ìŒì— ë©”ëª¨ ëª¨ë‹¬ ì‚½ì…
        addScheduleBtn.parentNode.insertBefore(memoModalOverlay, addScheduleBtn.nextSibling);
    } else {
        // ì¼ì • ì¶”ê°€ ë²„íŠ¼ì„ ì°¾ì§€ ëª»í•œ ê²½ìš° bodyì— ì¶”ê°€
        document.body.appendChild(memoModalOverlay);
    }
    
    memoModalOverlay.querySelector('#internal-memo-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        await updateMemo(scheduleId);
    });
    document.getElementById('memo-text-content').focus(); // textareaì— í¬ì»¤ìŠ¤
}

async function updateMemo(scheduleId) {
    const token = localStorage.getItem('token');
    if (!token) return;
    const memoContent = document.getElementById('memo-text-content').value;
    if (!memoContent.trim()) return;

    const now = getCurrentTime();
    const formattedDate = now.toLocaleDateString('ko-KR', {
        year: '2-digit',
        month: '2-digit',
        day: '2-digit'
    }).replace(/\./g, '').replace(/\s/g, '');

    const currentUserData = JSON.parse(localStorage.getItem('userData'));
    const userName = currentUserData ? currentUserData.name : 'ì•Œ ìˆ˜ ì—†ìŒ';

    const newMemoLine = `${formattedDate} (${userName}) : ${memoContent}`;

    try {
        // ê¸°ì¡´ ë©”ëª¨ ê°€ì ¸ì˜¤ê¸°
        const schedule = schedules.find(s => s.id === scheduleId);
        const existingMemo = schedule ? schedule.memo : '';
        
        // ê¸°ì¡´ ë©”ëª¨ê°€ ìˆìœ¼ë©´ ì¤„ë°”ê¿ˆ ì¶”ê°€
        const combinedMemo = existingMemo ? `${existingMemo}\n${newMemoLine}` : newMemoLine;

        const response = await fetch(`/schedules/${scheduleId}/memo`, {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ memo: combinedMemo }),
        });
        
        const data = await response.json();
        
        if (response.ok) {
            const memoModalOverlay = document.querySelector('.memo-modal-overlay');
            if (memoModalOverlay) memoModalOverlay.remove();
            
            // ìŠ¤ì¼€ì¤„ ëª©ë¡ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ë˜ëŠ” ëª¨ë‹¬ ë‚´ìš© ì—…ë°ì´íŠ¸
            const scheduleIndex = schedules.findIndex(s => s.id === scheduleId);
            if (scheduleIndex !== -1) {
                schedules[scheduleIndex].memo = data.memo;
            }
            // í˜„ì¬ ì—´ë ¤ìˆëŠ” ìƒì„¸ ëª¨ë‹¬ì´ ìˆë‹¤ë©´ í•´ë‹¹ ëª¨ë‹¬ë„ ì—…ë°ì´íŠ¸
            const detailModal = document.querySelector('.schedule-modal[data-schedule-id="'+scheduleId+'"]');
            if (detailModal) {
                const memoDiv = detailModal.querySelector('.memo-content');
                if (memoDiv) {
                    memoDiv.innerHTML = data.memo ? data.memo.split('\n').map(line => `<div>${line}</div>`).join('') : 'ì—†ìŒ';
                }
            }
            renderSchedules();
        } else {
            log('ERROR', 'Failed to update memo', data);
            alert(data.detail || 'ë©”ëª¨ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        log('ERROR', 'Update memo error', error);
        alert('ë©”ëª¨ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// User Filtering Functions
async function loadUserCheckboxes() {
    const token = localStorage.getItem('token');
    if (!token) return;
    try {
        const response = await fetch('/users/', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
            const users = await response.json();
            const container = document.getElementById('user-checkboxes');
            if (!container) return;
            container.innerHTML = ''; // Clear previous
            // "ì „ì²´ ì‚¬ìš©ì" ì˜µì…˜ ì¶”ê°€
            const allUsersDiv = document.createElement('div');
            allUsersDiv.className = 'user-checkbox';
            allUsersDiv.innerHTML = `
                <input type="checkbox" id="user-all" value="all" onchange="toggleAllUsersFilter(this.checked)" ${selectedUsers.size === 0 ? 'checked' : ''}>
                <label for="user-all">ëª¨ë“  ì‚¬ìš©ì</label>
            `;
            container.appendChild(allUsersDiv);

            users.forEach(user => {
                const div = document.createElement('div');
                div.className = 'user-checkbox';
                div.innerHTML = `
                    <input type="checkbox" id="user-${user.id}" value="${user.id}" 
                           onchange="toggleUserFilter(${user.id}, this.checked)"
                           ${selectedUsers.has(user.id) ? 'checked' : ''}>
                    <label for="user-${user.id}">${user.name} (${user.username})</label>
                `;
                container.appendChild(div);
            });
        } else {
             log('ERROR', 'Failed to load users for filter', {status: response.status});
        }
    } catch (error) {
        log('ERROR', 'Load users filter error', error);
    }
}

function toggleAllUsersFilter(checked) {
    const userCheckboxes = document.querySelectorAll('#user-checkboxes input[type="checkbox"]:not(#user-all)');
    if (checked) {
        selectedUsers.clear();
        userCheckboxes.forEach(cb => cb.checked = false);
    }
    // "ëª¨ë“  ì‚¬ìš©ì"ê°€ ì²´í¬ë˜ë©´ ë‹¤ë¥¸ í•„í„°ëŠ” ì˜ë¯¸ ì—†ìŒ (ë°±ì—”ë“œì—ì„œ user_ids íŒŒë¼ë¯¸í„° ì—†ì´ ìš”ì²­)
    // ë§Œì•½ "ëª¨ë“  ì‚¬ìš©ì" ì²´í¬ í•´ì œ ì‹œ, ì–´ë–¤ ë™ì‘ì„ í• ì§€ ì •ì˜ í•„ìš” (ì˜ˆ: ì´ì „ì— ì„ íƒëœ ì‚¬ìš©ì ë³µì› ë˜ëŠ” ì•„ë¬´ê²ƒë„ ì•ˆí•¨)
    // ì—¬ê¸°ì„œëŠ” "ëª¨ë“  ì‚¬ìš©ì" ì²´í¬ ì‹œ ë‹¤ë¥¸ ì‚¬ìš©ì ì„ íƒ í•´ì œí•˜ê³ , selectedUsers ë¹„ì›€.
    refreshSchedules();
    updateUserFilterCheckboxes();
}

function toggleUserFilter(userId, checked) {
    if (checked) {
        selectedUsers.add(userId);
    } else {
        selectedUsers.delete(userId);
    }
    // ë‹¤ë¥¸ ì‚¬ìš©ì í•„í„°ê°€ ì„ íƒë˜ë©´ "ëª¨ë“  ì‚¬ìš©ì"ëŠ” ìë™ í•´ì œ
    const allUserCb = document.getElementById('user-all');
    if (allUserCb) allUserCb.checked = selectedUsers.size === 0;
    
    refreshSchedules();
    updateUserFilterCheckboxes(); // ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë™ê¸°í™”
}

function updateUserFilterCheckboxes() {
    const allUserCb = document.getElementById('user-all');
    if (allUserCb) {
        allUserCb.checked = selectedUsers.size === 0;
    }
    document.querySelectorAll('#user-checkboxes input[type="checkbox"]:not(#user-all)').forEach(cb => {
        cb.checked = selectedUsers.has(parseInt(cb.value));
    });
}


// --- ALARM FUNCTIONS ---
let alarmPollingInterval = null;
let alarms = [];

async function loadAlarms() {
    const token = localStorage.getItem('token');
    if (!token) return;
    try {
        const response = await fetch('/alarms', { // API ì—”ë“œí¬ì¸íŠ¸ í™•ì¸
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
            const newAlarms = await response.json();
            if (JSON.stringify(alarms) !== JSON.stringify(newAlarms)) { // ë³€ê²½ì´ ìˆì„ ë•Œë§Œ ë Œë”ë§
                alarms = newAlarms;
                renderAlarms();
            }
        } else if (response.status === 401) {
            clearSession(); // í† í° ë§Œë£Œ ë“±
        } else {
            log('WARN', 'Failed to load alarms', { status: response.status });
            // renderAlarms(); // ë¹ˆ ëª©ë¡ ë˜ëŠ” ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
        }
    } catch (error) {
        log('ERROR', 'Load alarms error', error);
        // renderAlarms();
    }
}

// renderAlarms í•¨ìˆ˜ ìˆ˜ì • - ë¯¸í™•ì¸ ì•ŒëŒ ì²´í¬ ê¸°ëŠ¥ ì¶”ê°€
function renderAlarms() {
    const alarmListDiv = document.getElementById('alarm-list');
    if (!alarmListDiv) return;
    alarmListDiv.innerHTML = '';
    
    // ë¯¸í™•ì¸ ì•ŒëŒ ê°œìˆ˜ ì²´í¬
    const unackedCount = alarms.filter(alarm => !alarm.is_acked).length;
    updateAlarmIndicator(unackedCount);
    
    if (alarms.length === 0) {
        alarmListDiv.innerHTML = '<div class="no-alarms">ìƒˆë¡œìš´ ì•ŒëŒì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }
    alarms.slice().sort((a,b) => new Date(b.created_at) - new Date(a.created_at)).forEach(alarm => { // ìµœì‹ ìˆœ ì •ë ¬
        const alarmDiv = document.createElement('div');
        alarmDiv.className = `alarm-item ${alarm.type} ${alarm.is_acked ? 'acked' : 'unacked'}`;
        const createdTime = new Date(alarm.created_at).toLocaleString('ko-KR', {
            month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
        });
        alarmDiv.innerHTML = `
            <div class="alarm-content">
                <span class="alarm-type-badge">${getAlarmTypeText(alarm.type)}</span>
                <span class="alarm-message">${alarm.message}</span>
                <span class="alarm-time">${createdTime}</span>
                
            </div>
            <div class="alarm-actions">
                ${!alarm.is_acked ? `<button onclick="ackAlarm(${alarm.id})" class="ack-btn" title="í™•ì¸ë¨ìœ¼ë¡œ í‘œì‹œ">âœ”ï¸</button>` : `<span class="acked-mark" title="í™•ì¸ë¨">âœ…</span>`}
                <button onclick="deleteAlarm(${alarm.id})" class="delete-btn" title="ì•ŒëŒ ì‚­ì œ">ğŸ—‘ï¸</button>
                ${alarm.type === 'memo' ? `<button onclick="goToScheduleMemo(${alarm.schedule_id})" class="memo-link-btn">ì—´ê¸°</button>` : ''}
            </div>
        `;
        alarmListDiv.appendChild(alarmDiv);
    });
}

// ë©”ëª¨ë¡œ ì´ë™í•˜ëŠ” í•¨ìˆ˜
function goToScheduleMemo(scheduleId) {
    // í•´ë‹¹ ì¼ì •ì˜ í…Œì´ë¸” í–‰ ì°¾ê¸°
    const scheduleRow = document.querySelector(`tr[data-schedule-id="${scheduleId}"]`);
    if (!scheduleRow) {
        // data-schedule-id ì†ì„±ì´ ì—†ëŠ” ê²½ìš°, ì¼ì • ëª©ë¡ì—ì„œ í•´ë‹¹ IDë¥¼ ê°€ì§„ ì¼ì • ì°¾ê¸°
        const schedule = schedules.find(s => s.id === scheduleId);
        if (schedule) {
            // ì¼ì • ëª¨ë‹¬ ì—´ê¸°
            handleScheduleClick(schedule);
            // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì¡°ì •
            const scheduleContainer = document.querySelector('.schedule-container');
            if (scheduleContainer) {
                const scheduleIndex = schedules.findIndex(s => s.id === scheduleId);
                if (scheduleIndex !== -1) {
                    const rowHeight = 40; // ì˜ˆìƒë˜ëŠ” í–‰ ë†’ì´
                    const scrollPosition = scheduleIndex * rowHeight;
                    scheduleContainer.scrollTo({
                        top: scrollPosition,
                        behavior: 'smooth'
                    });
                }
            }
        }
    } else {
        // í–‰ì´ ìˆëŠ” ê²½ìš° í•´ë‹¹ í–‰ìœ¼ë¡œ ìŠ¤í¬ë¡¤
        scheduleRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
        // ì¼ì • ëª¨ë‹¬ ì—´ê¸°
        const schedule = schedules.find(s => s.id === scheduleId);
        if (schedule) {
            handleScheduleClick(schedule);
        }
    }
}

// ìƒˆë¡œìš´ í•¨ìˆ˜: ì•ŒëŒ ì¸ë””ì¼€ì´í„° ì—…ë°ì´íŠ¸
function updateAlarmIndicator(unackedCount) {
    const alarmCollapsible = document.getElementById('alarm-collapsible');
    const alarmHeaderCollapsible = alarmCollapsible?.querySelector('.alarm-header-collapsible');
    
    if (!alarmHeaderCollapsible) return;
    
    // ê¸°ì¡´ ì¸ë””ì¼€ì´í„° ì œê±°
    const existingIndicator = alarmHeaderCollapsible.querySelector('.unacked-indicator');
    if (existingIndicator) {
        existingIndicator.remove();
    }
    
    if (unackedCount > 0) {
        // ë¯¸í™•ì¸ ì•ŒëŒ ê°œìˆ˜ í‘œì‹œ
        const indicator = document.createElement('span');
        indicator.className = 'unacked-indicator';
        indicator.textContent = unackedCount;
        
        const h3 = alarmHeaderCollapsible.querySelector('h3');
        h3.appendChild(indicator);
        
        // ê¹œë¹¡ì„ íš¨ê³¼ ì‹œì‘
        alarmCollapsible.classList.add('has-unacked-alarms');
    } else {
        // ê¹œë¹¡ì„ íš¨ê³¼ ì œê±°
        alarmCollapsible.classList.remove('has-unacked-alarms');
    }
}

function getAlarmTypeText(type) {
    const map = { 'schedule_due': 'ì¼ì •ë§Œë£Œ', 'memo': 'ìƒˆë©”ëª¨', 'share': 'ê³µìœ ë¨', 'completion_request': 'ì™„ë£Œìš”ì²­', 'new_schedule': 'ìƒˆì¼ì •' };
    return map[type] || type;
}

// ackAlarmê³¼ deleteAlarm í•¨ìˆ˜ ìˆ˜ì •í•˜ì—¬ ì¸ë””ì¼€ì´í„° ì—…ë°ì´íŠ¸
async function ackAlarm(alarmId) {
    const token = localStorage.getItem('token');
    if (!token) return;
    try {
        const response = await fetch(`/ack_alarms/${alarmId}/ack`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
            await loadAlarms(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (renderAlarmsì—ì„œ ì¸ë””ì¼€ì´í„°ë„ ì—…ë°ì´íŠ¸ë¨)
        } else {
             log('ERROR', 'Failed to ack alarm', {status: response.status});
             alert('ì•ŒëŒ í™•ì¸ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        log('ERROR', 'Ack alarm error', error);
        alert('ì•ŒëŒ í™•ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ.');
    }
}



async function deleteAlarm(alarmId) {
    // í™•ì¸ ì—†ì´ ë°”ë¡œ ì‚­ì œ ë˜ëŠ” confirm ì¶”ê°€
    const token = localStorage.getItem('token');
    if (!token) return;
    try {
        const response = await fetch(`/delete_alarms/${alarmId}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
            await loadAlarms(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (renderAlarmsì—ì„œ ì¸ë””ì¼€ì´í„°ë„ ì—…ë°ì´íŠ¸ë¨)
        } else {
            log('ERROR', 'Failed to delete alarm', {status: response.status});
            alert('ì•ŒëŒ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        log('ERROR', 'Delete alarm error', error);
        alert('ì•ŒëŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ.');
    }
}

async function clearAllAlarms() {
    if (!confirm('ì½ì€ ì•ŒëŒì„ í¬í•¨í•˜ì—¬ ëª¨ë“  ì•ŒëŒì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
    const token = localStorage.getItem('token');
    if (!token) return;
    try {
        const response = await fetch('/clear_alarms/clear', { // ì—”ë“œí¬ì¸íŠ¸ í™•ì¸ /clear_alarms/clear ë˜ëŠ” /alarms/clear_all
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
            await loadAlarms(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (renderAlarmsì—ì„œ ì¸ë””ì¼€ì´í„°ë„ ì—…ë°ì´íŠ¸ë¨)
            alert('ëª¨ë“  ì•ŒëŒì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
            log('ERROR', 'Failed to clear all alarms', {status: response.status});
            alert('ëª¨ë“  ì•ŒëŒ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        log('ERROR', 'Clear all alarms error', error);
        alert('ëª¨ë“  ì•ŒëŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ.');
    }
}

function startAlarmPolling() {
    stopAlarmPolling(); // ê¸°ì¡´ ì¸í„°ë²Œì´ ìˆë‹¤ë©´ ì¤‘ì§€
    loadAlarms(); // ì¦‰ì‹œ í•œë²ˆ ë¡œë“œ
    alarmPollingInterval = setInterval(loadAlarms, 30000); // 30ì´ˆë§ˆë‹¤
    log('INFO', 'Alarm polling started.');
}

function stopAlarmPolling() {
    if (alarmPollingInterval) {
        clearInterval(alarmPollingInterval);
        alarmPollingInterval = null;
        log('INFO', 'Alarm polling stopped.');
    }
}

// --- BROWSER NOTIFICATIONS (for schedule due times) ---
// (ì´ ë¶€ë¶„ì€ ë°±ì—… íŒŒì¼ì— ìˆë˜ setInterval(checkScheduleAlarms, 60000)ê³¼ ìœ ì‚¬)
function checkScheduleAlarmsForNotification() {
    const now = getCurrentTime();
    schedules.forEach(schedule => {
        if (schedule.alarm_time && !schedule.is_completed) {
            const alarmTime = new Date(schedule.alarm_time);
            // ì•ŒëŒ ì‹œê°„ì´ í˜„ì¬ ì‹œê°„ ì´ì „ì´ê³ , ë§ˆì§€ë§‰ ì•Œë¦¼ ì²´í¬ ì‹œê°„ë³´ë‹¤ ì´í›„ì¸ ê²½ìš° ì•Œë¦¼ (ì¤‘ë³µ ë°©ì§€)
            if (alarmTime <= now && (!schedule.last_notified_at || new Date(schedule.last_notified_at) < alarmTime)) {
                showBrowserNotification('ì¼ì • ì•Œë¦¼: ' + schedule.title, schedule.content || 'ì„¸ë¶€ ë‚´ìš© ì—†ìŒ');
                schedule.last_notified_at = now.toISOString(); // ì•Œë¦¼ ë°œìƒ ì‹œê°„ ê¸°ë¡ (í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ)
            }
        }
    });
}
// ì£¼ê¸°ì ìœ¼ë¡œ ì²´í¬
// setInterval(checkScheduleAlarmsForNotification, 60000); // 1ë¶„ë§ˆë‹¤

function showBrowserNotification(title, body) {
    if (!("Notification" in window)) {
        log('WARN', 'Browser does not support notifications.');
        return;
    }
    if (Notification.permission === "granted") {
        new Notification(title, { body, icon: '/icon.png' }); // ì•„ì´ì½˜ ê²½ë¡œ ì¶”ê°€ ê°€ëŠ¥
    } else if (Notification.permission !== "denied") {
        Notification.requestPermission().then(permission => {
            if (permission === "granted") {
                new Notification(title, { body, icon: '/icon.png' });
            }
        });
    }
}
// í˜ì´ì§€ ë¡œë“œ ì‹œ ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ (ì„ íƒì )
// document.addEventListener('DOMContentLoaded', () => {
//     if (Notification.permission !== "granted" && Notification.permission !== "denied") {
//         Notification.requestPermission();
//     }
// });


// Global Error Handlers
window.addEventListener('error', (event) => {
    log('ERROR', 'Global error caught', {
        message: event.message, filename: event.filename,
        lineno: event.lineno, colno: event.colno, error: event.error
    });
});
window.addEventListener('unhandledrejection', (event) => {
    log('ERROR', 'Unhandled promise rejection', { reason: event.reason });
});

// í…ŒìŠ¤íŠ¸ìš©: ëª¨ë“  ì¼ì • ì‚­ì œ í•¨ìˆ˜
async function deleteAllSchedules() {
    if (!confirm('ì •ë§ë¡œ ëª¨ë“  ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
    
    const token = localStorage.getItem('token');
    if (!token) return;

    try {
        // ë¨¼ì € ëª¨ë“  ì¼ì • ëª©ë¡ì„ ê°€ì ¸ì˜µë‹ˆë‹¤
        const response = await fetch('/schedules/', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) {
            throw new Error('ì¼ì • ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
        
        const schedules = await response.json();
        
        // ê° ì¼ì •ì„ ìˆœì°¨ì ìœ¼ë¡œ ì‚­ì œ
        for (const schedule of schedules) {
            const deleteResponse = await fetch(`/schedules/${schedule.id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (!deleteResponse.ok) {
                console.error(`ì¼ì • ID ${schedule.id} ì‚­ì œ ì‹¤íŒ¨`);
            }
        }
        
        // ì¼ì • ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        await refreshSchedules();
        alert('ëª¨ë“  ì¼ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        
    } catch (error) {
        log('ERROR', 'Delete all schedules error', error);
        alert('ì¼ì • ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// í…ŒìŠ¤íŠ¸ìš©: ëª¨ë“  ì¼ì • ì‚­ì œ ë²„íŠ¼ ì¶”ê°€
function addDeleteAllButton() {
    const controls = document.querySelector('.controls');
    if (!controls) return;
    
    const deleteAllButton = document.createElement('button');
    deleteAllButton.textContent = 'ëª¨ë“  ì¼ì • ì‚­ì œ';
    deleteAllButton.onclick = deleteAllSchedules;
    deleteAllButton.style.backgroundColor = '#dc3545'; // ë¹¨ê°„ìƒ‰ ë°°ê²½
    deleteAllButton.style.color = 'white';
    deleteAllButton.style.marginLeft = '10px';
    
    controls.appendChild(deleteAllButton);
}

async function loadProjectList() {
    const token = localStorage.getItem('token');
    if (!token) return;
    try {
        const response = await fetch('/projects/', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
            const projects = await response.json();
            const projectInput = document.getElementById('schedule-project');
            const projectList = document.getElementById('project-list');
            if (projectList) {
                projectList.innerHTML = '';
                projects.forEach(project => {
                    const option = document.createElement('div');
                    option.className = 'project-option';
                    option.textContent = project.name;
                    option.onclick = () => {
                        projectInput.value = project.name;
                        projectList.style.display = 'none';
                    };
                    projectList.appendChild(option);
                });
            }
        }
    } catch (error) {
        log('ERROR', 'Load project list error', error);
    }
}

function renderControls() {
    const controlsDiv = document.querySelector('.controls');
    if (!controlsDiv) return;
    
    controlsDiv.innerHTML = `
        <button onclick="toggleCompletedFilter()">ì™„ë£Œëœ ì¼ì • ${showCompleted ? 'ìˆ¨ê¸°ê¸°' : 'ë³´ê¸°'}</button>
        <button onclick="toggleAllUsersFilter(!showAllUsers)">ëª¨ë“  ì‚¬ìš©ì ${showAllUsers ? 'ìˆ¨ê¸°ê¸°' : 'ë³´ê¸°'}</button>
        <button onclick="toggleCompletedOnly()">ì™„ë£Œëœ ì¼ì •ë§Œ ${completedOnly ? 'í•´ì œ' : 'ë³´ê¸°'}</button>
        <button onclick="showDateRangeModal()" class="excel-export-btn">
            <i class="fas fa-file-excel"></i> ì—‘ì…€ë¡œ ì¶œë ¥
        </button>
        <button onclick="showAddScheduleForm()" class="add-schedule-btn">ì¼ì • ì¶”ê°€</button>
    `;
}

async function exportToExcel(startDate, endDate) {
    const token = localStorage.getItem('token');
    if (!token) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        return;
    }

    if (!startDate || !endDate) {
        alert('ì‹œì‘ ë‚ ì§œì™€ ì¢…ë£Œ ë‚ ì§œë¥¼ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }

    try {
        // ë¡œë”© í‘œì‹œ
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'loading-overlay';
        loadingDiv.innerHTML = '<div class="loading-spinner"></div><div>ì—‘ì…€ íŒŒì¼ ìƒì„± ì¤‘...</div>';
        document.body.appendChild(loadingDiv);

        // ë‚ ì§œ í˜•ì‹ ë³€í™˜ (YYYY-MM-DD)
        const formattedStartDate = new Date(startDate).toISOString().split('T')[0];
        const formattedEndDate = new Date(endDate).toISOString().split('T')[0];

        const response = await fetch(`/schedules/export/excel?start_date=${formattedStartDate}&end_date=${formattedEndDate}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || 'ì—‘ì…€ íŒŒì¼ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }

        // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `schedules_export_${formattedStartDate}_to_${formattedEndDate}.xlsx`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

    } catch (error) {
        console.error('Export error:', error);
        alert(error.message || 'ì—‘ì…€ íŒŒì¼ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
        // ë¡œë”© í‘œì‹œ ì œê±°
        const loadingDiv = document.querySelector('.loading-overlay');
        if (loadingDiv) {
            document.body.removeChild(loadingDiv);
        }
    }
}

function toggleCompletedOnly() {
    completedOnly = !completedOnly;
    refreshSchedules();
    renderControls();
}

function showDateRangeModal() {
    const modal = document.getElementById('date-range-modal');
    modal.style.display = 'block';
    
    // ì˜¤ëŠ˜ ë‚ ì§œë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
    const today = new Date().toISOString().split('T')[0];
    const startDateInput = document.getElementById('start-date');
    const endDateInput = document.getElementById('end-date');
    
    // ì´ì „ì— ì„ íƒí•œ ë‚ ì§œê°€ ìˆìœ¼ë©´ ìœ ì§€, ì—†ìœ¼ë©´ ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì„¤ì •
    startDateInput.value = startDateInput.value || today;
    endDateInput.value = endDateInput.value || today;
}

function closeDateRangeModal() {
    const modal = document.getElementById('date-range-modal');
    modal.style.display = 'none';
}

async function confirmExport() {
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;
    
    if (!startDate || !endDate) {
        alert('ì‹œì‘ ë‚ ì§œì™€ ì¢…ë£Œ ë‚ ì§œë¥¼ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    if (new Date(startDate) > new Date(endDate)) {
        alert('ì‹œì‘ ë‚ ì§œëŠ” ì¢…ë£Œ ë‚ ì§œë³´ë‹¤ ì´í›„ì¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    await exportToExcel(startDate, endDate);
    closeDateRangeModal();
}