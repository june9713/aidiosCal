# 히스토리 0015 - showScheduleInterface 함수 누락 문제 해결

## 작업 날짜: 2025-06-02

## 문제 상황
- 사용자가 브라우저를 닫았다 열어도 세션이 유지되는 현상 발견
- JavaScript 에러 발생: `ReferenceError: showScheduleInterface is not defined`
- `fetchUserProfile` 함수에서 `showScheduleInterface()` 호출하지만 함수가 정의되지 않음

## 세션 유지 메커니즘 분석

### 백엔드 세션 관리 (FastAPI + JWT)
1. **인증 플로우**:
   - `/token` 엔드포인트에서 사용자 인증 후 JWT 토큰 생성
   - JWT 토큰을 HttpOnly 쿠키로 설정 (`session_token`)
   - 토큰 만료 시간: 30일 (ACCESS_TOKEN_EXPIRE_MINUTES = 43200분)

2. **쿠키 설정**:
   ```python
   response.set_cookie(
       key="session_token",
       value=access_token,
       max_age=ACCESS_TOKEN_EXPIRE_MINUTES * 60,  # 초 단위
       httponly=True,
       secure=False,  # HTTPS 환경에서는 True
       samesite="lax"
   )
   ```

3. **세션 검증**:
   - `/check-session` 엔드포인트에서 쿠키의 토큰 검증
   - `get_current_user` 함수에서 OAuth2PasswordBearer 사용
   - `decode_access_token` 함수로 JWT 토큰 디코딩

### 프론트엔드 세션 관리 (JavaScript)
1. **토큰 저장**: localStorage에 토큰과 사용자 데이터 저장
2. **자동 로그인**: DOMContentLoaded 시 저장된 토큰으로 `fetchUserProfile` 호출
3. **토큰 갱신**: `/token/refresh` 엔드포인트로 토큰 자동 갱신

## 에러 해결 과정

### 1. 문제 파악
- `fetchUserProfile` 함수에서 `showScheduleInterface()` 호출 (main.js:330)
- 하지만 `showScheduleInterface` 함수가 현재 main.js에 정의되지 않음
- 백업 파일(backup/backup_main.js_backup)에는 존재함

### 2. 함수 복원
백업 파일에서 `showScheduleInterface` 함수를 복사하여 main.js에 추가:

```javascript
function showScheduleInterface() {
    log('INFO', 'showScheduleInterface 시작');
    if (!authContainer) {
        log('ERROR', 'authContainer not found');
        return;
    }
    
    // 인터페이스 HTML 생성
    authContainer.innerHTML = `...`;
    
    // 초기화 함수들 호출
    loadUserCheckboxes();
    loadAlarms();
    setupInfiniteScroll();
    updateToggleCompletedButtonText();
    addDeleteAllButton();
    main_loadSchedules(); // 초기 일정 로드
}
```

### 3. 주요 기능
- 컨트롤 패널 (완료 일정 토글, 파일 보기, 엑셀 출력, 로그아웃)
- 사용자 필터
- 알람 관리
- 일정 추가 버튼
- 스케줄 테이블

## 해결 결과
- `showScheduleInterface is not defined` 에러 해결
- 사용자 로그인 후 정상적으로 스케줄 인터페이스 표시
- 브라우저 재시작 시에도 세션 유지 및 자동 로그인 동작

## 향후 개선사항
1. 토큰 만료 시간 조정 검토 (현재 30일은 너무 길 수 있음)
2. HTTPS 환경에서 secure=True 설정 필요
3. 세션 보안 강화 방안 검토 